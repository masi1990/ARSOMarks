<div class="max-w-6xl mx-auto py-8 px-4">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-slate-900">Product Traceability & Verification</h1>
    <p class="text-slate-600 mt-1">
      Public directory of certified products with QR-enabled Certificate of Conformity (COC) checks.
    </p>
  </div>

  <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-4 mb-4">
    <div class="grid gap-3 md:grid-cols-4">
      <div class="md:col-span-2">
        <label class="text-sm font-semibold text-slate-700 mb-1 block">Search</label>
        <input
          [formControl]="search"
          placeholder="COC number, product, brand, standard..."
          class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-blue-600 focus:outline-none"
        />
      </div>
      <div>
        <label class="text-sm font-semibold text-slate-700 mb-1 block">Category</label>
        <select [(ngModel)]="categoryFilter" (change)="applyFilters()" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm">
          <option value="">All</option>
          <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
        </select>
      </div>
      <div>
        <label class="text-sm font-semibold text-slate-700 mb-1 block">Origin Country</label>
        <select [(ngModel)]="countryFilter" (change)="applyFilters()" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm">
          <option value="">All</option>
          <option *ngFor="let c of countries" [value]="c">{{ c }}</option>
        </select>
      </div>
      <div>
        <label class="text-sm font-semibold text-slate-700 mb-1 block">Standard</label>
        <select [(ngModel)]="standardFilter" (change)="applyFilters()" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm">
          <option value="">All</option>
          <option *ngFor="let s of standards" [value]="s">{{ s }}</option>
        </select>
      </div>
      <div class="flex items-end">
        <button (click)="clearFilters()" class="w-full text-sm font-semibold text-slate-700 bg-slate-100 px-3 py-2 rounded-lg hover:bg-slate-200">
          Clear filters
        </button>
      </div>
      <div class="flex items-end">
        <a routerLink="/traceability/verify" class="w-full text-center text-sm font-semibold text-white bg-blue-600 px-3 py-2 rounded-lg hover:bg-blue-700">
          Scan / verify token
        </a>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="bg-white border border-slate-200 rounded-xl p-6 text-center">Loading...</div>
  <div *ngIf="error" class="bg-red-50 border border-red-200 rounded-xl p-4 text-red-800">{{ error }}</div>

  <div *ngIf="!loading" class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
      <h2 class="font-semibold text-slate-900">Certified Products ({{ filtered.length }})</h2>
      <span class="text-xs text-slate-500">Geo data is logged server-side for anti-counterfeit surveillance.</span>
    </div>
    <div *ngIf="filtered.length === 0" class="p-6 text-sm text-slate-600">No products found with current filters.</div>
    <div *ngIf="filtered.length > 0" class="divide-y divide-slate-200">
      <div
        *ngFor="let p of filtered"
        class="flex flex-col md:flex-row md:items-center md:justify-between px-4 py-3 hover:bg-slate-50 transition"
      >
        <div class="space-y-1">
          <div class="flex items-center gap-2">
            <span class="font-mono text-blue-700 text-sm font-semibold">{{ p.cocNumber }}</span>
            <span class="text-xs text-slate-500">{{ p.originCountryName || p.countryOfOrigin || 'Origin N/A' }}</span>
          </div>
          <div class="font-semibold text-slate-900">{{ p.productName || 'Product' }}</div>
          <div class="text-sm text-slate-600">
            {{ p.brand }} • {{ p.category || 'Category N/A' }}
          </div>
          <div class="flex flex-wrap gap-1">
            <span *ngFor="let s of p.standards" class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded">
              {{ s }}
            </span>
          </div>
          <div class="text-xs text-slate-500">
            Issued {{ formatDate(p.issueDate) }} • Expires {{ formatDate(p.expiryDate) }}
            <span *ngIf="isExpired(p.expiryDate)" class="text-red-600 font-semibold">(Expired)</span>
          </div>
        </div>
        <div class="mt-3 md:mt-0 flex items-center gap-2">
          <a [routerLink]="['/traceability/product', p.id]" class="text-sm font-semibold text-blue-700 hover:underline">Details</a>
          <a [routerLink]="['/traceability/verify']" [queryParams]="{ token: p.qrUrl }" class="text-sm text-slate-700 hover:underline">
            Open verification
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
