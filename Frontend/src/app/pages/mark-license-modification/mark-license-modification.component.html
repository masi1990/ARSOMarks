<div class="w-full max-w-6xl mx-auto">
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <!-- Header -->
    <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50">
      <h1 class="text-2xl font-bold text-slate-900">License Modification Request</h1>
      <p class="mt-1 text-sm font-medium text-slate-600">Form NSB-004-4: Request to Modify Existing ARSO Mark License</p>
      <p *ngIf="agreement" class="mt-1 text-sm text-slate-500">License: {{ agreement.agreementId }}</p>
      <div *ngIf="existingModification" class="mt-2">
        <span class="px-3 py-1 rounded-full text-sm font-semibold" [ngClass]="getStatusBadgeClass(existingModification.status)">
          {{ existingModification.status }}
        </span>
      </div>
    </div>

    <div *ngIf="success" class="mx-8 mt-6 p-4 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-800">
      <p class="font-semibold">{{ successMessage }}</p>
    </div>

    <div *ngIf="error" class="mx-8 mt-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800">
      {{ error }}
    </div>

    <form [formGroup]="form" class="p-8 space-y-10" *ngIf="!loading">
      <!-- Modification Details -->
      <section class="space-y-6">
        <h2 class="text-lg font-bold text-slate-900 border-b border-slate-200 pb-3">Modification Details</h2>
        
        <div *ngIf="agreement" class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h3 class="font-semibold text-slate-900 mb-2">Current License Information</h3>
          <div class="grid gap-4 md:grid-cols-2 text-sm">
            <div>
              <span class="font-semibold">Agreement ID:</span> {{ agreement.agreementId }}
            </div>
            <div>
              <span class="font-semibold">License Type:</span> {{ agreement.licenseTypeDisplay }}
            </div>
            <div>
              <span class="font-semibold">Start Date:</span> {{ formatDate(agreement.licenseStartDate) }}
            </div>
            <div>
              <span class="font-semibold">End Date:</span> {{ formatDate(agreement.licenseEndDate) }}
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <label class="block text-sm font-semibold text-slate-700">Type of Modification <span class="text-red-500">*</span></label>
          <div class="space-y-2">
            <label *ngFor="let option of modificationTypeOptions" class="flex items-center space-x-2 cursor-pointer">
              <input
                type="checkbox"
                [value]="option.value"
                formControlName="modificationTypes"
                class="rounded border-slate-300 text-blue-600 focus:ring-blue-600"
              />
              <span class="text-sm text-slate-700">{{ option.label }}</span>
            </label>
          </div>
          <p *ngIf="form.get('modificationTypes')?.invalid && form.get('modificationTypes')?.touched" class="text-xs text-red-500 mt-1">
            At least one modification type must be selected
          </p>
        </div>

        <div class="space-y-2">
          <label for="modificationReason" class="block text-sm font-semibold text-slate-700">Reason for Modification <span class="text-red-500">*</span></label>
          <textarea
            id="modificationReason"
            formControlName="modificationReason"
            rows="4"
            class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-blue-600 focus:ring-1 focus:ring-blue-600 focus:outline-none"
            placeholder="Explain why this modification is needed"
          ></textarea>
        </div>

        <div class="space-y-2">
          <label for="proposedChanges" class="block text-sm font-semibold text-slate-700">Proposed Changes <span class="text-red-500">*</span></label>
          <textarea
            id="proposedChanges"
            formControlName="proposedChanges"
            rows="6"
            class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-blue-600 focus:ring-1 focus:ring-blue-600 focus:outline-none"
            placeholder="Describe in detail what changes you are requesting"
          ></textarea>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
          <div class="space-y-2">
            <label for="effectiveDateRequest" class="block text-sm font-semibold text-slate-700">Requested Effective Date <span class="text-red-500">*</span></label>
            <input
              type="date"
              id="effectiveDateRequest"
              formControlName="effectiveDateRequest"
              class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-blue-600 focus:ring-1 focus:ring-blue-600 focus:outline-none"
            />
          </div>

          <div class="space-y-2">
            <label for="feeAdjustmentNeeded" class="block text-sm font-semibold text-slate-700">Fee Adjustment Needed <span class="text-red-500">*</span></label>
            <select
              id="feeAdjustmentNeeded"
              formControlName="feeAdjustmentNeeded"
              class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-blue-600 focus:ring-1 focus:ring-blue-600 focus:outline-none"
            >
              <option value="" disabled>Select option</option>
              <option *ngFor="let option of feeAdjustmentOptions" [value]="option.value">{{ option.label }}</option>
            </select>
          </div>
        </div>

        <div class="space-y-2">
          <label for="impactAssessment" class="block text-sm font-semibold text-slate-700">Impact Assessment</label>
          <textarea
            id="impactAssessment"
            formControlName="impactAssessment"
            rows="4"
            class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm focus:border-blue-600 focus:ring-1 focus:ring-blue-600 focus:outline-none"
            placeholder="How will these changes affect your usage of the marks?"
          ></textarea>
        </div>

        <div class="space-y-2">
          <label class="block text-sm font-semibold text-slate-700">Supporting Justification Document</label>
          <input
            type="file"
            (change)="onJustificationFileSelected($event)"
            accept=".pdf,.doc,.docx"
            class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm"
          />
          <p class="text-xs text-slate-500 mt-1">Upload business case document or justification (PDF, DOC, DOCX)</p>
          <div *ngIf="justificationFile" class="mt-2 flex items-center justify-between p-2 bg-slate-50 rounded">
            <span class="text-sm text-slate-700">{{ justificationFile.name }}</span>
            <button type="button" (click)="removeJustificationFile()" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
          </div>
        </div>
      </section>

      <!-- Existing Modification Status (if viewing) -->
      <section *ngIf="existingModification && existingModification.status !== 'PENDING'" class="space-y-6">
        <h2 class="text-lg font-bold text-slate-900 border-b border-slate-200 pb-3">Review Status</h2>
        
        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 space-y-3">
          <div class="grid gap-4 md:grid-cols-2 text-sm">
            <div>
              <span class="font-semibold">Status:</span>
              <span class="ml-2 px-2 py-1 rounded text-xs font-semibold" [ngClass]="getStatusBadgeClass(existingModification.status)">
                {{ existingModification.status }}
              </span>
            </div>
            <div *ngIf="existingModification.reviewedAt">
              <span class="font-semibold">Reviewed At:</span> {{ formatDate(existingModification.reviewedAt) }}
            </div>
          </div>

          <div *ngIf="existingModification.rejectionReason" class="p-3 bg-red-50 rounded border border-red-200">
            <p class="font-semibold text-red-800 text-sm mb-1">Rejection Reason:</p>
            <p class="text-sm text-red-700">{{ existingModification.rejectionReason }}</p>
          </div>

          <div *ngIf="existingModification.implementedChanges" class="p-3 bg-green-50 rounded border border-green-200">
            <p class="font-semibold text-green-800 text-sm mb-1">Implemented Changes:</p>
            <pre class="text-sm text-green-700 whitespace-pre-wrap">{{ existingModification.implementedChanges | json }}</pre>
          </div>
        </div>
      </section>

      <!-- Form Actions -->
      <div class="flex gap-4 justify-end pt-6 border-t border-slate-200" *ngIf="!existingModification || existingModification.status === 'PENDING'">
        <button
          type="button"
          (click)="submitModification()"
          [disabled]="submitting || form.invalid"
          class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          <span *ngIf="!submitting">Submit Modification Request</span>
          <span *ngIf="submitting">Submitting...</span>
        </button>
      </div>

      <div class="flex gap-4 justify-end pt-6 border-t border-slate-200" *ngIf="existingModification && existingModification.status !== 'PENDING'">
        <button
          type="button"
          (click)="navigateToDashboard()"
          class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          Back to Dashboard
        </button>
      </div>
    </form>

    <div *ngIf="loading" class="p-8 text-center">
      <p class="text-slate-600">Loading...</p>
    </div>
  </div>
</div>

