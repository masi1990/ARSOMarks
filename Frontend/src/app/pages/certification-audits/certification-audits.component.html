<div class="min-h-screen bg-gray-50 py-8 px-4">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-2 border-gray-200">
      <h1 class="text-2xl font-bold text-gray-900">Certification Audits</h1>
      <p class="text-gray-600">Plan audits, log findings, sampling and test results.</p>
    </div>

    <div *ngIf="error" class="mb-6 p-4 bg-red-50 border-2 border-red-400 text-red-800 rounded-lg">
      {{ error }}
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-2 border-gray-200">
      <h2 class="text-lg font-semibold mb-4">Create Audit</h2>
      <div [formGroup]="auditForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input formControlName="applicationId" class="form-control" placeholder="Application ID" />
        <select formControlName="auditType" class="form-control">
          <option value="">Select audit type...</option>
          <option *ngFor="let type of auditTypes" [value]="type">{{ type }}</option>
        </select>
        <input type="date" formControlName="plannedDate" class="form-control" />
        <input type="date" formControlName="windowStart" class="form-control" placeholder="Window start" />
        <input type="date" formControlName="windowEnd" class="form-control" placeholder="Window end" />
        <label class="flex items-center gap-2">
          <input type="checkbox" formControlName="isUnannounced" />
          <span>Unannounced audit</span>
        </label>
        <textarea formControlName="notes" class="form-control md:col-span-2" rows="2" placeholder="Notes"></textarea>
      </div>
      <button type="button" (click)="createAudit()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded">
        Create Audit
      </button>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-2 border-gray-200">
      <h2 class="text-lg font-semibold mb-4">Laboratories</h2>
      <div [formGroup]="labForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input formControlName="name" class="form-control" placeholder="Lab name" />
        <input formControlName="accreditationNumber" class="form-control" placeholder="Accreditation number" />
        <input formControlName="scope" class="form-control md:col-span-2" placeholder="Scope" />
        <label class="flex items-center gap-2">
          <input type="checkbox" formControlName="isAccredited" />
          <span>Accredited</span>
        </label>
      </div>
      <button type="button" (click)="createLaboratory()" class="mt-4 px-4 py-2 bg-gray-700 text-white rounded">
        Add Laboratory
      </button>
    </div>

    <div *ngIf="loading" class="bg-white rounded-lg shadow-md p-6 border-2 border-gray-200 text-center">
      Loading audits...
    </div>

    <div *ngIf="!loading && audits.length === 0" class="bg-white rounded-lg shadow-md p-6 border-2 border-gray-200 text-center">
      No audits found.
    </div>

    <div *ngIf="audits.length > 0" class="space-y-4">
      <div *ngFor="let audit of audits" class="bg-white rounded-lg shadow-md p-6 border-2 border-gray-200">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-semibold">{{ audit.auditType }}</h3>
            <p class="text-sm text-gray-600">Status: {{ audit.status }}</p>
          </div>
          <button type="button" (click)="selectAudit(audit.id)" class="px-3 py-2 bg-blue-100 text-blue-800 rounded">
            Manage
          </button>
        </div>

        <div *ngIf="selectedAuditId === audit.id" class="mt-6 space-y-6">
          <div [formGroup]="findingForm" class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold mb-2">Add Finding</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <select formControlName="findingType" class="form-control">
                <option value="">Select finding type...</option>
                <option *ngFor="let type of findingTypes" [value]="type">{{ type }}</option>
              </select>
              <input type="date" formControlName="deadlineDate" class="form-control" />
              <textarea formControlName="description" class="form-control md:col-span-2" rows="2" placeholder="Finding description"></textarea>
            </div>
            <button type="button" (click)="addFinding()" class="mt-3 px-3 py-2 bg-blue-600 text-white rounded">
              Add Finding
            </button>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold mb-2">Findings</h4>
            <div *ngIf="!(audit.findings && audit.findings.length)" class="text-sm text-gray-600">No findings yet.</div>
            <div *ngFor="let finding of audit.findings || []" class="border rounded p-3 mb-3">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-sm font-semibold">{{ finding.findingType }}</div>
                  <div class="text-xs text-gray-600">
                    Status: {{ finding.status }} | Deadline: {{ finding.deadlineDate || 'N/A' }}
                  </div>
                </div>
              </div>
              <p class="text-sm text-gray-800 mt-2">{{ finding.description }}</p>

              <div class="mt-3">
                <div class="text-xs font-semibold uppercase text-gray-600">Evidence</div>
                <div
                  *ngIf="(findingEvidence[finding.id] || []).length === 0"
                  class="text-xs text-gray-500 mb-2"
                >
                  No evidence uploaded.
                </div>
                <ul
                  *ngIf="(findingEvidence[finding.id] || []).length > 0"
                  class="list-disc list-inside text-sm space-y-1 mb-2"
                >
                  <li *ngFor="let ev of findingEvidence[finding.id]">
                    {{ ev.originalName }} ({{ ev.mimeType }}, {{ ev.size | number }} bytes)
                    <a
                      class="text-blue-600 underline"
                      [href]="evidenceService.getDownloadUrl(ev.id)"
                      target="_blank"
                      rel="noopener"
                    >
                      Download
                    </a>
                    <span *ngIf="ev.description" class="text-gray-600">â€” {{ ev.description }}</span>
                  </li>
                </ul>

                <div class="space-y-2">
                  <input type="file" multiple (change)="onEvidenceFilesSelected(finding.id, $event)" />
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Evidence description (optional)"
                    (input)="onEvidenceDescriptionChange(finding.id, $event.target.value)"
                  />
                  <button
                    type="button"
                    (click)="uploadFindingEvidence(finding.id)"
                    [disabled]="uploadingEvidence[finding.id]"
                    class="px-3 py-2 bg-green-600 text-white rounded"
                  >
                    {{ uploadingEvidence[finding.id] ? 'Uploading...' : 'Upload Evidence' }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div [formGroup]="samplingForm" class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold mb-2">Add Sampling Record</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input formControlName="samplingMethod" class="form-control" placeholder="Sampling method" />
              <input formControlName="samplingLocation" class="form-control" placeholder="Sampling location" />
              <input formControlName="quantity" class="form-control" placeholder="Quantity" />
              <input formControlName="quantityUnit" class="form-control" placeholder="Unit" />
              <input type="date" formControlName="sampledAt" class="form-control" />
              <textarea formControlName="traceability" class="form-control md:col-span-2" rows="2" placeholder="Traceability"></textarea>
            </div>
            <button type="button" (click)="addSampling()" class="mt-3 px-3 py-2 bg-blue-600 text-white rounded">
              Add Sampling
            </button>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold mb-2">Sampling Records</h4>
            <div *ngFor="let sampling of audit.samplingRecords || []" class="border rounded p-3 mb-2">
              <div class="flex justify-between items-center">
                <div class="text-sm">Sampling ID: {{ sampling.id }}</div>
                <button type="button" (click)="selectSampling(sampling.id)" class="text-xs px-2 py-1 bg-gray-200 rounded">
                  Add Test Result
                </button>
              </div>
              <div class="text-xs text-gray-600">Status: {{ sampling.status }}</div>
            </div>

            <div *ngIf="selectedSamplingId" [formGroup]="testResultForm" class="mt-4">
              <h5 class="font-semibold mb-2">Add Test Result</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <select formControlName="laboratoryId" class="form-control">
                  <option value="">Select laboratory...</option>
                  <option *ngFor="let lab of laboratories" [value]="lab.id">{{ lab.name }}</option>
                </select>
                <select formControlName="resultStatus" class="form-control">
                  <option value="">Select result...</option>
                  <option *ngFor="let status of testResultStatuses" [value]="status">{{ status }}</option>
                </select>
                <input formControlName="reportFilePath" class="form-control" placeholder="Report file path" />
                <input type="date" formControlName="testedAt" class="form-control" />
                <textarea formControlName="parametersJson" class="form-control md:col-span-2" rows="2" placeholder='{"parameter":"value"}'></textarea>
              </div>
              <button type="button" (click)="addTestResult()" class="mt-3 px-3 py-2 bg-blue-600 text-white rounded">
                Add Test Result
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
