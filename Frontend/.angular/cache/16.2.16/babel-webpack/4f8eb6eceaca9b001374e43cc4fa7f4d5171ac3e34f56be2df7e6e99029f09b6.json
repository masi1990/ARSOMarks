{"ast":null,"code":"import { FormArray, FormGroup, Validators } from '@angular/forms';\nimport { finalize } from 'rxjs';\nimport { MediaType, MarkType } from '../../shared/models/mark-license.model';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/forms\";\nimport * as i2 from \"../../modules/mark-licensing/services/mark-usage-report.service\";\nimport * as i3 from \"../../modules/mark-licensing/services/mark-license-agreement.service\";\nimport * as i4 from \"@angular/router\";\nexport let MarkUsageReportComponent = /*#__PURE__*/(() => {\n  class MarkUsageReportComponent {\n    constructor(fb, reportService, agreementService, route, router) {\n      this.fb = fb;\n      this.reportService = reportService;\n      this.agreementService = agreementService;\n      this.route = route;\n      this.router = router;\n      this.loading = false;\n      this.saving = false;\n      this.submitting = false;\n      this.error = '';\n      this.success = false;\n      this.successMessage = '';\n      this.licenseId = null;\n      this.agreement = null;\n      this.existingReport = null;\n      this.reportId = null;\n      // Options\n      this.mediaTypeOptions = [{\n        value: MediaType.DIGITAL_ONLINE,\n        label: 'Digital/Online'\n      }, {\n        value: MediaType.PRINT,\n        label: 'Print'\n      }, {\n        value: MediaType.BROADCAST,\n        label: 'Broadcast'\n      }, {\n        value: MediaType.OUTDOOR,\n        label: 'Outdoor'\n      }, {\n        value: MediaType.EVENTS,\n        label: 'Events'\n      }, {\n        value: MediaType.SOCIAL_MEDIA,\n        label: 'Social Media'\n      }, {\n        value: MediaType.OTHER,\n        label: 'Other'\n      }];\n      this.markTypeOptions = [{\n        value: MarkType.ARSO_QUALITY_MARK,\n        label: 'ARSO Quality Mark'\n      }, {\n        value: MarkType.ECO_MARK_AFRICA,\n        label: 'Eco Mark Africa (EMA)'\n      }, {\n        value: MarkType.BOTH,\n        label: 'Both'\n      }];\n      this.renewalIntentionOptions = [{\n        value: 'YES',\n        label: 'Yes'\n      }, {\n        value: 'NO',\n        label: 'No'\n      }, {\n        value: 'UNDECIDED',\n        label: 'Undecided'\n      }];\n      this.evidenceTypeOptions = [{\n        value: 'CAMPAIGN_PHOTOS',\n        label: 'Campaign Photos'\n      }, {\n        value: 'MEDIA_CLIPPINGS',\n        label: 'Media Clippings'\n      }, {\n        value: 'SCREENSHOTS',\n        label: 'Screenshots'\n      }, {\n        value: 'ANALYTICS_REPORTS',\n        label: 'Analytics Reports'\n      }];\n      this.sampleTypeOptions = [{\n        value: 'BROCHURE',\n        label: 'Brochure'\n      }, {\n        value: 'ADVERTISEMENT',\n        label: 'Advertisement'\n      }, {\n        value: 'PRODUCT_LABEL',\n        label: 'Product Label'\n      }];\n      // File uploads\n      this.supportingEvidenceFiles = [];\n      this.sampleFiles = [];\n      this.testimonialFiles = [];\n      this.form = this.createForm();\n    }\n    ngOnInit() {\n      this.route.params.subscribe(params => {\n        this.licenseId = params['licenseId'];\n        this.reportId = params['id'];\n        if (this.licenseId) {\n          this.loadAgreement();\n        }\n        if (this.reportId) {\n          this.loadReport();\n        }\n      });\n    }\n    createForm() {\n      return this.fb.group({\n        licenseId: ['', [Validators.required]],\n        reportPeriodStart: ['', [Validators.required]],\n        reportPeriodEnd: ['', [Validators.required]],\n        nsbContactName: ['', [Validators.required]],\n        nsbContactEmail: ['', [Validators.required, Validators.email]],\n        // Promotional Usage Metrics Array\n        promotionalUsageMetrics: this.fb.array([]),\n        // Certification Usage Metrics Array\n        certificationUsageMetrics: this.fb.array([]),\n        // Impact Assessment\n        impactAssessment: this.fb.group({\n          awarenessIncrease: [''],\n          inquiriesReceived: ['', [Validators.required]],\n          partnershipsFormed: [''],\n          mediaCoverage: [''],\n          successStories: this.fb.array([]),\n          challengesFaced: this.fb.array([])\n        }),\n        // Compliance Declaration\n        complianceChecks: this.fb.group({\n          usedMarksOnlyAsAuthorized: [false, [Validators.requiredTrue]],\n          followedBrandGuidelines: [false, [Validators.requiredTrue]],\n          didNotModifyMarks: [false, [Validators.requiredTrue]],\n          usedCurrentVersionOfMarks: [false, [Validators.requiredTrue]]\n        }),\n        nonComplianceIssues: [''],\n        correctiveActionsTaken: [''],\n        plannedUsageNextYear: ['', [Validators.required]],\n        renewalIntention: ['', [Validators.required]]\n      });\n    }\n    loadAgreement() {\n      if (!this.licenseId) return;\n      this.loading = true;\n      this.agreementService.getAgreementById(this.licenseId).pipe(finalize(() => {\n        this.loading = false;\n      })).subscribe({\n        next: agreement => {\n          this.agreement = agreement;\n          this.form.patchValue({\n            licenseId: this.licenseId\n          });\n          // Set default report period (last 12 months)\n          const endDate = new Date();\n          const startDate = new Date();\n          startDate.setFullYear(startDate.getFullYear() - 1);\n          this.form.patchValue({\n            reportPeriodStart: startDate.toISOString().split('T')[0],\n            reportPeriodEnd: endDate.toISOString().split('T')[0],\n            nsbContactName: agreement.nsbSignerName,\n            nsbContactEmail: agreement.nsbSignerEmail\n          });\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to load license agreement.';\n        }\n      });\n    }\n    loadReport() {\n      if (!this.reportId) return;\n      this.loading = true;\n      this.reportService.getReportById(this.reportId).pipe(finalize(() => {\n        this.loading = false;\n      })).subscribe({\n        next: report => {\n          this.existingReport = report;\n          this.licenseId = report.licenseId;\n          this.loadAgreement();\n          this.loadReportData(report);\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to load report.';\n        }\n      });\n    }\n    loadReportData(report) {\n      this.form.patchValue({\n        reportPeriodStart: report.reportPeriodStart.split('T')[0],\n        reportPeriodEnd: report.reportPeriodEnd.split('T')[0],\n        nsbContactName: report.nsbContactName,\n        nsbContactEmail: report.nsbContactEmail,\n        nonComplianceIssues: report.nonComplianceIssues,\n        correctiveActionsTaken: report.correctiveActionsTaken,\n        plannedUsageNextYear: report.plannedUsageNextYear,\n        renewalIntention: report.renewalIntention\n      });\n      if (report.impactAssessment) {\n        this.form.get('impactAssessment')?.patchValue({\n          awarenessIncrease: report.impactAssessment.awarenessIncrease,\n          inquiriesReceived: report.impactAssessment.inquiriesReceived,\n          partnershipsFormed: report.impactAssessment.partnershipsFormed,\n          mediaCoverage: report.impactAssessment.mediaCoverage\n        });\n      }\n      if (report.complianceChecks) {\n        this.form.get('complianceChecks')?.patchValue(report.complianceChecks);\n      }\n      // Load arrays\n      if (report.promotionalUsageMetrics) {\n        report.promotionalUsageMetrics.forEach(metric => {\n          this.addPromotionalUsage();\n          const lastIndex = this.promotionalUsageArray.length - 1;\n          this.promotionalUsageArray.at(lastIndex).patchValue(metric);\n        });\n      }\n      if (report.certificationUsageMetrics) {\n        report.certificationUsageMetrics.forEach(metric => {\n          this.addCertificationUsage();\n          const lastIndex = this.certificationUsageArray.length - 1;\n          this.certificationUsageArray.at(lastIndex).patchValue(metric);\n        });\n      }\n    }\n    // Getters for form arrays\n    get promotionalUsageArray() {\n      return this.form.get('promotionalUsageMetrics');\n    }\n    get certificationUsageArray() {\n      return this.form.get('certificationUsageMetrics');\n    }\n    get successStoriesArray() {\n      return this.form.get('impactAssessment.successStories');\n    }\n    get challengesArray() {\n      return this.form.get('impactAssessment.challengesFaced');\n    }\n    // Add/Remove array items\n    addPromotionalUsage() {\n      const usageGroup = this.fb.group({\n        mediaCampaignName: ['', [Validators.required]],\n        mediaTypeReported: ['', [Validators.required]],\n        markUsed: ['', [Validators.required]],\n        usagePeriodStart: ['', [Validators.required]],\n        usagePeriodEnd: ['', [Validators.required]],\n        audienceReached: [''],\n        impressions: [''],\n        engagementMetrics: [''],\n        campaignCost: ['']\n      });\n      this.promotionalUsageArray.push(usageGroup);\n    }\n    removePromotionalUsage(index) {\n      this.promotionalUsageArray.removeAt(index);\n    }\n    addCertificationUsage() {\n      const usageGroup = this.fb.group({\n        sector: ['', [Validators.required]],\n        certificationsIssued: ['', [Validators.required]],\n        markAppearances: ['', [Validators.required]],\n        clientFeedback: [''],\n        nonConformities: ['', [Validators.required]],\n        correctiveActions: ['']\n      });\n      this.certificationUsageArray.push(usageGroup);\n    }\n    removeCertificationUsage(index) {\n      this.certificationUsageArray.removeAt(index);\n    }\n    addSuccessStory() {\n      this.successStoriesArray.push(this.fb.control('', [Validators.required]));\n    }\n    removeSuccessStory(index) {\n      this.successStoriesArray.removeAt(index);\n    }\n    addChallenge() {\n      this.challengesArray.push(this.fb.control('', [Validators.required]));\n    }\n    removeChallenge(index) {\n      this.challengesArray.removeAt(index);\n    }\n    // File upload handlers\n    onSupportingEvidenceSelected(event, type) {\n      const file = event.target.files[0];\n      if (file) {\n        this.supportingEvidenceFiles.push({\n          file,\n          type\n        });\n      }\n    }\n    removeSupportingEvidence(index) {\n      this.supportingEvidenceFiles.splice(index, 1);\n    }\n    onSampleSelected(event, type) {\n      const file = event.target.files[0];\n      if (file) {\n        this.sampleFiles.push({\n          file,\n          type\n        });\n      }\n    }\n    removeSample(index) {\n      this.sampleFiles.splice(index, 1);\n    }\n    onTestimonialSelected(event) {\n      const files = Array.from(event.target.files);\n      this.testimonialFiles = [...this.testimonialFiles, ...files];\n    }\n    removeTestimonial(index) {\n      this.testimonialFiles.splice(index, 1);\n    }\n    // Form submission\n    saveDraft() {\n      if (this.form.invalid) {\n        this.markFormGroupTouched(this.form);\n        this.error = 'Please fill in all required fields correctly.';\n        return;\n      }\n      this.saving = true;\n      this.error = '';\n      const formValue = this.form.getRawValue();\n      const payload = {\n        ...formValue,\n        supportingEvidence: this.supportingEvidenceFiles.map(doc => ({\n          fileName: doc.file.name,\n          evidenceType: doc.type\n        })),\n        samples: this.sampleFiles.map(doc => ({\n          fileName: doc.file.name,\n          materialType: doc.type\n        })),\n        testimonials: this.testimonialFiles.map(file => ({\n          fileName: file.name\n        }))\n      };\n      const operation = this.existingReport ? this.reportService.updateReport(this.existingReport.id, payload) : this.reportService.createReport(payload);\n      operation.pipe(finalize(() => {\n        this.saving = false;\n      })).subscribe({\n        next: report => {\n          this.existingReport = report;\n          this.success = true;\n          this.successMessage = 'Report saved as draft successfully.';\n          setTimeout(() => {\n            this.success = false;\n          }, 3000);\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to save report. Please try again.';\n        }\n      });\n    }\n    submitReport() {\n      if (this.form.invalid) {\n        this.markFormGroupTouched(this.form);\n        this.error = 'Please fill in all required fields correctly before submitting.';\n        return;\n      }\n      if (!this.existingReport) {\n        this.error = 'Please save the report as draft first.';\n        return;\n      }\n      this.submitting = true;\n      this.error = '';\n      this.reportService.submitReport(this.existingReport.id).pipe(finalize(() => {\n        this.submitting = false;\n      })).subscribe({\n        next: () => {\n          this.success = true;\n          this.successMessage = 'Report submitted successfully!';\n          setTimeout(() => {\n            this.router.navigate(['/mark-licenses/dashboard']);\n          }, 2000);\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to submit report. Please try again.';\n        }\n      });\n    }\n    markFormGroupTouched(formGroup) {\n      Object.keys(formGroup.controls).forEach(key => {\n        const control = formGroup.get(key);\n        control?.markAsTouched();\n        if (control instanceof FormGroup) {\n          this.markFormGroupTouched(control);\n        } else if (control instanceof FormArray) {\n          control.controls.forEach(arrayControl => {\n            if (arrayControl instanceof FormGroup) {\n              this.markFormGroupTouched(arrayControl);\n            } else {\n              arrayControl.markAsTouched();\n            }\n          });\n        }\n      });\n    }\n    static {\n      this.ɵfac = function MarkUsageReportComponent_Factory(t) {\n        return new (t || MarkUsageReportComponent)(i0.ɵɵdirectiveInject(i1.FormBuilder), i0.ɵɵdirectiveInject(i2.MarkUsageReportService), i0.ɵɵdirectiveInject(i3.MarkLicenseAgreementService), i0.ɵɵdirectiveInject(i4.ActivatedRoute), i0.ɵɵdirectiveInject(i4.Router));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: MarkUsageReportComponent,\n        selectors: [[\"app-mark-usage-report\"]],\n        decls: 0,\n        vars: 0,\n        template: function MarkUsageReportComponent_Template(rf, ctx) {},\n        styles: [\"(()[_ngcontent-%COMP%]   =[_ngcontent-%COMP%] >  {// webpackBootstrap \\\"use strict\\\";})()[_ngcontent-%COMP%] ;{%BLOCK%}\"]\n      });\n    }\n  }\n  return MarkUsageReportComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}