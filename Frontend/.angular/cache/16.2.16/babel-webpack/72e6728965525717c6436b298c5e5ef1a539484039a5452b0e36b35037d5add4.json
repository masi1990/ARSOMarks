{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators } from '@angular/forms';\nimport { finalize } from 'rxjs';\nimport { NsbRegistrationRequestStatus, NsbDocumentType } from '../../shared/models/nsb-registration-request.model';\nimport { UserRole } from '../../shared/models/user.model';\nexport let NsbRegistrationRequestComponent = class NsbRegistrationRequestComponent {\n  constructor(fb, requestService, countryService, nsbService, router, authService) {\n    this.fb = fb;\n    this.requestService = requestService;\n    this.countryService = countryService;\n    this.nsbService = nsbService;\n    this.router = router;\n    this.authService = authService;\n    this.loading = false;\n    this.saving = false;\n    this.error = '';\n    this.success = false;\n    this.countries = [];\n    this.existingRequest = null;\n    this.activeTab = 'form';\n    this.registeredNsbs = [];\n    this.loadingNsbs = false;\n    this.formMode = 'edit';\n    this.draftRequests = [];\n    this.loadingDrafts = false;\n    this.customSectorInput = '';\n    this.documentTypes = [{\n      value: NsbDocumentType.NSB_ESTABLISHMENT_CHARTER,\n      label: 'NSB Establishment Charter/Act'\n    }, {\n      value: NsbDocumentType.ARSO_MEMBERSHIP_CERTIFICATE,\n      label: 'ARSO Membership Certificate'\n    }, {\n      value: NsbDocumentType.GOVERNMENT_GAZETTE_NOTICE,\n      label: 'Government Gazette Notice'\n    }, {\n      value: NsbDocumentType.DECLARATION_OF_AUTHORITY,\n      label: 'Declaration of Authority'\n    }];\n    this.selectedFiles = {};\n    this.selectedSectors = [];\n    this.requestedRolesOptions = [{\n      value: 'MARKET_SURVEILLANCE_OFFICER',\n      label: 'Market Surveillance Officer'\n    }, {\n      value: 'CERTIFICATION_LIAISON_OFFICER',\n      label: 'Certification Liaison Officer'\n    }, {\n      value: 'TRAINING_COORDINATOR',\n      label: 'Training Coordinator'\n    }, {\n      value: 'COMMUNICATIONS_OFFICER',\n      label: 'Communications Officer'\n    }];\n    this.form = this.fb.group({\n      countryId: ['', [Validators.required]],\n      countryName: [{\n        value: '',\n        disabled: true\n      }, [Validators.required]],\n      nsbOfficialName: ['', [Validators.required, Validators.maxLength(255)]],\n      nsbAcronym: ['', [Validators.maxLength(50)]],\n      isoCode: ['', [Validators.required, Validators.minLength(2), Validators.maxLength(2)]],\n      contactPersonName: ['', [Validators.required, Validators.maxLength(255)]],\n      contactPersonTitle: ['', [Validators.maxLength(255)]],\n      contactEmail: ['', [Validators.required, Validators.email, Validators.maxLength(255)]],\n      contactPhone: ['', [Validators.maxLength(50)]],\n      contactMobile: ['', [Validators.maxLength(50)]],\n      additionalUserSlotsRequested: [0, [Validators.min(0)]],\n      requestedRoles: [[]],\n      sectors: [[]]\n    });\n  }\n  ngOnInit() {\n    this.resetFormState();\n    this.loadCountries();\n    this.setupCountryWatcher();\n    this.loadRegisteredNsbs();\n  }\n  onTabChange(tab) {\n    this.activeTab = tab;\n    if (tab === 'form') {\n      this.resetFormState();\n    }\n    if (tab === 'drafts') {\n      this.loadDraftRequests();\n    }\n  }\n  loadRegisteredNsbs() {\n    this.loadingNsbs = true;\n    // Show all submitted requests (any non-draft status)\n    this.requestService.list({\n      limit: 1000\n    }).subscribe({\n      next: response => {\n        this.registeredNsbs = (response.data || []).filter(req => req.status !== NsbRegistrationRequestStatus.DRAFT).map(req => ({\n          requestId: req.id,\n          name: req.nsbOfficialName,\n          countryName: req.countryName || req.country?.name || 'N/A',\n          status: req.status,\n          approvalStatus: req.status,\n          request: req\n        }));\n        this.loadingNsbs = false;\n      },\n      error: err => {\n        if (err.status !== 403 && err.status !== 404) {\n          console.warn('Failed to load submitted NSB requests:', err);\n        }\n        this.registeredNsbs = [];\n        this.loadingNsbs = false;\n      }\n    });\n  }\n  setupCountryWatcher() {\n    this.form.get('countryId')?.valueChanges.subscribe(countryId => {\n      const country = this.countries.find(c => c.id === countryId);\n      if (country) {\n        this.form.patchValue({\n          countryName: country.name,\n          isoCode: country.isoCode || ''\n        });\n      }\n    });\n  }\n  loadCountries() {\n    this.loading = true;\n    this.countryService.getCountries().pipe(finalize(() => {\n      this.loading = false;\n    })).subscribe({\n      next: data => {\n        this.countries = data;\n      },\n      error: () => {\n        this.error = 'Failed to load countries. Please try again.';\n      }\n    });\n  }\n  checkExistingRequest() {\n    const user = this.authService.currentUserValue;\n    if (user?.countryId) {\n      this.requestService.getMyRequest(user.countryId).subscribe({\n        next: request => {\n          if (request) {\n            this.existingRequest = request;\n            this.loadRequestData(request);\n          }\n        },\n        error: () => {\n          // No existing request, continue\n        }\n      });\n    }\n  }\n  loadRequestData(request) {\n    this.form.patchValue({\n      countryId: request.countryId,\n      countryName: request.countryName,\n      nsbOfficialName: request.nsbOfficialName,\n      nsbAcronym: request.nsbAcronym,\n      isoCode: request.isoCode,\n      contactPersonName: request.contactPersonName,\n      contactPersonTitle: request.contactPersonTitle,\n      contactEmail: request.contactEmail,\n      contactPhone: request.contactPhone,\n      contactMobile: request.contactMobile,\n      additionalUserSlotsRequested: request.additionalUserSlotsRequested || 0,\n      requestedRoles: request.requestedRoles || [],\n      sectors: request.sectors || []\n    });\n    this.selectedSectors = request.sectors || [];\n  }\n  onFileSelected(event, documentType) {\n    const input = event.target;\n    if (input.files && input.files[0]) {\n      const file = input.files[0];\n      // Validate file size (10MB max)\n      const maxSize = 10 * 1024 * 1024; // 10MB in bytes\n      if (file.size > maxSize) {\n        this.error = `File size exceeds 10MB limit. Please select a smaller file.`;\n        input.value = ''; // Clear the input\n        return;\n      }\n      // Validate file type\n      const allowedTypes = ['.pdf', '.doc', '.docx'];\n      const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();\n      if (!allowedTypes.includes(fileExtension)) {\n        this.error = `Invalid file type. Please upload PDF, DOC, or DOCX files only.`;\n        input.value = ''; // Clear the input\n        return;\n      }\n      this.selectedFiles[documentType] = file;\n      this.error = ''; // Clear any previous errors\n      // Upload file immediately if request exists\n      if (this.existingRequest?.id) {\n        this.uploadFile(documentType, file);\n      }\n    }\n  }\n  uploadFile(documentType, file) {\n    if (!this.existingRequest?.id) {\n      return;\n    }\n    this.requestService.uploadDocument(this.existingRequest.id, file, documentType).subscribe({\n      next: () => {\n        // File uploaded successfully, reload request to get updated documents\n        this.loadRequest();\n        // Clear the selected file since it's now uploaded\n        delete this.selectedFiles[documentType];\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to upload file. Please try again.';\n        // Don't delete selectedFiles here - user might want to retry\n      }\n    });\n  }\n\n  removeFile(documentType) {\n    if (!this.existingRequest?.id) {\n      delete this.selectedFiles[documentType];\n      return;\n    }\n    // Find document ID\n    const document = this.existingRequest.documents?.find(d => d.documentType === documentType);\n    if (document?.id) {\n      this.requestService.deleteDocument(this.existingRequest.id, document.id).subscribe({\n        next: () => {\n          delete this.selectedFiles[documentType];\n          this.loadRequest();\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to delete file. Please try again.';\n        }\n      });\n    } else {\n      delete this.selectedFiles[documentType];\n    }\n  }\n  loadRequest() {\n    if (!this.existingRequest?.id) {\n      return;\n    }\n    this.requestService.get(this.existingRequest.id).subscribe({\n      next: request => {\n        this.existingRequest = request;\n        this.loadRequestData(request);\n      },\n      error: () => {\n        // Error loading request\n      }\n    });\n  }\n  onSubmit() {\n    // Allow saving draft even if form is invalid\n    // Only mark fields as touched to show validation errors, but don't prevent saving\n    if (this.form.invalid) {\n      this.form.markAllAsTouched();\n      // Continue with save anyway for draft\n    }\n\n    this.saving = true;\n    this.error = '';\n    const dto = this.buildRequestDto();\n    const request$ = this.existingRequest ? this.requestService.update(this.existingRequest.id, dto) : this.requestService.create(dto);\n    request$.pipe(finalize(() => {\n      this.saving = false;\n    })).subscribe({\n      next: request => {\n        this.existingRequest = request;\n        this.success = true;\n        // Reload request to get updated documents\n        this.loadRequest();\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to save registration request. Please try again.';\n      }\n    });\n  }\n  onSubmitForReview() {\n    if (this.form.invalid) {\n      this.form.markAllAsTouched();\n      this.error = 'Please complete all required fields before submitting.';\n      return;\n    }\n    // First save the request if it doesn't exist\n    if (!this.existingRequest?.id) {\n      this.saving = true;\n      this.error = '';\n      const dto = this.buildRequestDto();\n      this.requestService.create(dto).pipe(finalize(() => {\n        this.saving = false;\n      })).subscribe({\n        next: request => {\n          this.existingRequest = request;\n          // Upload any selected files that haven't been uploaded yet\n          this.uploadPendingFiles().then(() => {\n            // Reload request to get updated documents, then check and submit\n            this.loadRequest();\n            setTimeout(() => {\n              this.checkAndSubmitDocuments();\n            }, 500);\n          });\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to save registration request. Please try again.';\n        }\n      });\n      return;\n    }\n    // Update the existing draft with current form values before submitting\n    this.saving = true;\n    this.error = '';\n    const dto = this.buildRequestDto();\n    this.requestService.update(this.existingRequest.id, dto).pipe(finalize(() => {\n      this.saving = false;\n    })).subscribe({\n      next: request => {\n        this.existingRequest = request;\n        // Upload any pending files first\n        this.uploadPendingFiles().then(() => {\n          // Reload request to get updated documents, then check and submit\n          this.loadRequest();\n          setTimeout(() => {\n            this.checkAndSubmitDocuments();\n          }, 500);\n        });\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to save registration request. Please try again.';\n      }\n    });\n  }\n  uploadPendingFiles() {\n    const uploadPromises = [];\n    const requiredDocs = [NsbDocumentType.NSB_ESTABLISHMENT_CHARTER, NsbDocumentType.ARSO_MEMBERSHIP_CERTIFICATE, NsbDocumentType.GOVERNMENT_GAZETTE_NOTICE, NsbDocumentType.DECLARATION_OF_AUTHORITY];\n    // Upload any selected files that haven't been uploaded yet\n    requiredDocs.forEach(docType => {\n      const file = this.selectedFiles[docType];\n      if (file && this.existingRequest?.id) {\n        // Check if this document type is already uploaded\n        const isAlreadyUploaded = this.existingRequest.documents?.some(d => d.documentType === docType);\n        if (!isAlreadyUploaded) {\n          const uploadPromise = new Promise((resolve, reject) => {\n            this.uploadFile(docType, file);\n            // Wait a bit for upload to complete\n            setTimeout(() => {\n              resolve();\n            }, 1000);\n          });\n          uploadPromises.push(uploadPromise);\n        }\n      }\n    });\n    return Promise.all(uploadPromises).then(() => {\n      // All uploads initiated, wait a bit more for them to complete\n      return new Promise(resolve => {\n        setTimeout(() => {\n          resolve();\n        }, 1500);\n      });\n    });\n  }\n  checkAndSubmitDocuments() {\n    // Check if required documents are uploaded\n    const requiredDocs = [NsbDocumentType.NSB_ESTABLISHMENT_CHARTER, NsbDocumentType.ARSO_MEMBERSHIP_CERTIFICATE, NsbDocumentType.GOVERNMENT_GAZETTE_NOTICE, NsbDocumentType.DECLARATION_OF_AUTHORITY];\n    // Reload request to ensure we have the latest documents\n    if (!this.existingRequest?.id) {\n      this.error = 'Please save the request first before submitting.';\n      return;\n    }\n    // Get fresh request data\n    this.requestService.get(this.existingRequest.id).subscribe({\n      next: request => {\n        this.existingRequest = request;\n        const uploadedDocTypes = request.documents?.map(d => d.documentType) || [];\n        const missingDocs = requiredDocs.filter(doc => !uploadedDocTypes.includes(doc));\n        if (missingDocs.length > 0) {\n          const missingLabels = missingDocs.map(doc => {\n            const docType = this.documentTypes.find(d => d.value === doc);\n            return docType?.label || doc;\n          });\n          this.error = `Please upload all required documents before submitting. Missing: ${missingLabels.join(', ')}`;\n          return;\n        }\n        // All documents uploaded, proceed with submission\n        this.saving = true;\n        this.requestService.submit(this.existingRequest.id).pipe(finalize(() => {\n          this.saving = false;\n        })).subscribe({\n          next: submittedRequest => {\n            this.existingRequest = submittedRequest;\n            this.success = true;\n            this.error = '';\n          },\n          error: err => {\n            this.error = err.error?.message || 'Failed to submit request. Please try again.';\n          }\n        });\n      },\n      error: () => {\n        this.error = 'Failed to load request. Please try again.';\n      }\n    });\n  }\n  buildRequestDto() {\n    const formValue = this.form.getRawValue();\n    // Exclude documents from DTO - they are uploaded separately via file upload endpoint\n    const {\n      documents,\n      ...formDataWithoutDocuments\n    } = formValue;\n    return {\n      ...formDataWithoutDocuments\n    };\n  }\n  getDocumentLabel(documentType) {\n    const doc = this.documentTypes.find(d => d.value === documentType);\n    return doc?.label || documentType;\n  }\n  getFileName(documentType) {\n    const file = this.selectedFiles[documentType];\n    return file ? file.name : '';\n  }\n  getUploadedDocument(documentType) {\n    return this.existingRequest?.documents?.find(d => d.documentType === documentType);\n  }\n  toggleRole(roleValue) {\n    const currentRoles = this.form.get('requestedRoles')?.value || [];\n    const index = currentRoles.indexOf(roleValue);\n    if (index > -1) {\n      currentRoles.splice(index, 1);\n    } else {\n      currentRoles.push(roleValue);\n    }\n    this.form.patchValue({\n      requestedRoles: currentRoles\n    });\n  }\n  addCustomSector() {\n    const sector = this.customSectorInput.trim();\n    if (sector && !this.selectedSectors.includes(sector)) {\n      this.selectedSectors.push(sector);\n      this.form.patchValue({\n        sectors: this.selectedSectors\n      });\n      this.customSectorInput = '';\n    }\n  }\n  removeSector(sector) {\n    const index = this.selectedSectors.indexOf(sector);\n    if (index > -1) {\n      this.selectedSectors.splice(index, 1);\n      this.form.patchValue({\n        sectors: this.selectedSectors\n      });\n    }\n  }\n  onSectorInputKeydown(event) {\n    if (event.key === 'Enter') {\n      event.preventDefault();\n      this.addCustomSector();\n    }\n  }\n  loadDraftRequests() {\n    this.loadingDrafts = true;\n    this.draftRequests = [];\n    const user = this.authService.currentUserValue;\n    const userRoles = user?.roles || (user?.role ? [user.role] : []);\n    const isSuperAdmin = userRoles.includes(UserRole.SUPER_ADMIN) || userRoles.includes(UserRole.ARSO_SECRETARIAT);\n    if (isSuperAdmin) {\n      // Super admins can see all draft requests\n      this.requestService.list({\n        status: NsbRegistrationRequestStatus.DRAFT,\n        limit: 1000\n      }).subscribe({\n        next: response => {\n          this.draftRequests = (response.data || []).filter(req => req.status === NsbRegistrationRequestStatus.DRAFT);\n          this.loadingDrafts = false;\n        },\n        error: err => {\n          console.error('Failed to load draft requests:', err);\n          this.draftRequests = [];\n          this.loadingDrafts = false;\n        }\n      });\n    } else {\n      // Regular users should use getMyRequest directly (they don't have permission to list)\n      const countryId = user?.countryId || this.existingRequest?.countryId || this.form.get('countryId')?.value;\n      if (countryId) {\n        this.requestService.getMyRequest(countryId).subscribe({\n          next: request => {\n            this.draftRequests = request && request.status === NsbRegistrationRequestStatus.DRAFT ? [request] : [];\n            this.loadingDrafts = false;\n          },\n          error: err => {\n            // 404 is expected if no request exists - not an error\n            if (err.status === 404) {\n              this.draftRequests = [];\n            } else {\n              console.error('Failed to load draft request:', err);\n              if (this.existingRequest?.status === NsbRegistrationRequestStatus.DRAFT) {\n                this.draftRequests = [this.existingRequest];\n              }\n            }\n            this.loadingDrafts = false;\n          }\n        });\n      } else {\n        if (this.existingRequest?.status === NsbRegistrationRequestStatus.DRAFT) {\n          this.draftRequests = [this.existingRequest];\n        }\n        this.loadingDrafts = false;\n      }\n    }\n  }\n  loadDraftRequest(request) {\n    this.existingRequest = request;\n    this.loadRequestData(request);\n    this.setFormMode('edit');\n    this.activeTab = 'form';\n  }\n  deleteDraftRequest(request) {\n    if (!request.id) {\n      this.error = 'Cannot delete request: ID is missing.';\n      return;\n    }\n    if (confirm(`Are you sure you want to delete the draft request for \"${request.nsbOfficialName}\"? This action cannot be undone.`)) {\n      this.loadingDrafts = true;\n      this.requestService.delete(request.id).subscribe({\n        next: () => {\n          // Remove from list\n          this.draftRequests = this.draftRequests.filter(r => r.id !== request.id);\n          this.loadingDrafts = false;\n          // If this was the current request, clear it\n          if (this.existingRequest?.id === request.id) {\n            this.existingRequest = null;\n            this.form.reset();\n            this.selectedSectors = [];\n            this.selectedFiles = {};\n          }\n        },\n        error: err => {\n          console.error('Failed to delete draft request:', err);\n          this.error = err.error?.message || 'Failed to delete draft request. Please try again.';\n          this.loadingDrafts = false;\n        }\n      });\n    }\n  }\n  viewDocument(documentType) {\n    const document = this.getUploadedDocument(documentType);\n    if (document?.id && this.existingRequest?.id) {\n      // Fetch document via HTTP client (includes auth headers) and open as blob URL\n      this.requestService.getDocumentBlob(this.existingRequest.id, document.id).subscribe({\n        next: blob => {\n          const url = URL.createObjectURL(blob);\n          window.open(url, '_blank');\n          // Clean up the blob URL after a delay (optional, but good practice)\n          setTimeout(() => URL.revokeObjectURL(url), 100);\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to load document. Please try again.';\n        }\n      });\n    } else if (this.selectedFiles[documentType]) {\n      // Preview local file that hasn't been uploaded yet\n      const file = this.selectedFiles[documentType];\n      if (file) {\n        const url = URL.createObjectURL(file);\n        window.open(url, '_blank');\n      }\n    }\n  }\n  getApprovalStatus(nsb) {\n    // Check if NSB has an associated registration request\n    // This is a simplified version - in reality, you'd check the request status\n    if (nsb.status === 'ACTIVE') {\n      return 'APPROVED';\n    } else if (nsb.status === 'SUSPENDED') {\n      return 'SUSPENDED';\n    } else if (nsb.status === 'PENDING') {\n      return 'PENDING_APPROVAL';\n    }\n    return 'UNKNOWN';\n  }\n  editNsb(nsbId) {\n    // Navigate to NSB edit page or open edit modal\n    this.router.navigate(['/portal/nsb/dashboard'], {\n      queryParams: {\n        edit: nsbId\n      }\n    });\n  }\n  viewNsb(nsbId) {\n    // Navigate to NSB view page\n    this.router.navigate(['/portal/nsb/dashboard'], {\n      queryParams: {\n        view: nsbId\n      }\n    });\n  }\n  deleteNsb(nsbId) {\n    if (confirm('Are you sure you want to delete this NSB? This action cannot be undone.')) {\n      // TODO: Implement delete API call\n      alert(`Delete functionality for NSBs will be implemented soon.`);\n    }\n  }\n  suspendNsb(nsbId) {\n    if (confirm('Are you sure you want to suspend this NSB?')) {\n      // TODO: Implement suspend API call\n      alert(`Suspend functionality for NSBs will be implemented soon.`);\n    }\n  }\n  viewRequest(requestId) {\n    this.loadRequestForAction(requestId, 'view');\n  }\n  editRequest(requestId) {\n    this.loadRequestForAction(requestId, 'edit');\n  }\n  suspendRequest(requestId) {\n    if (!confirm('Are you sure you want to suspend this registration request?')) {\n      return;\n    }\n    this.requestService.updateStatus(requestId, NsbRegistrationRequestStatus.REJECTED, 'Suspended by admin').subscribe({\n      next: () => {\n        this.loadRegisteredNsbs();\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to suspend registration request.';\n      }\n    });\n  }\n  deleteRequest(requestId) {\n    if (!confirm('Are you sure you want to delete this registration request? This action cannot be undone.')) {\n      return;\n    }\n    this.requestService.delete(requestId).subscribe({\n      next: () => {\n        this.loadRegisteredNsbs();\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to delete registration request.';\n      }\n    });\n  }\n  loadRequestForAction(requestId, mode) {\n    this.requestService.get(requestId).subscribe({\n      next: request => {\n        this.existingRequest = request;\n        this.loadRequestData(request);\n        this.setFormMode(mode);\n        this.activeTab = 'form';\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to load registration request.';\n      }\n    });\n  }\n  setFormMode(mode) {\n    this.formMode = mode;\n    if (mode === 'view') {\n      this.form.disable({\n        emitEvent: false\n      });\n    } else {\n      this.form.enable({\n        emitEvent: false\n      });\n    }\n    // Keep derived fields read-only\n    this.form.get('countryName')?.disable({\n      emitEvent: false\n    });\n  }\n  viewNotifications(nsbId) {\n    this.router.navigate(['/portal/nsb/communication'], {\n      queryParams: {\n        nsbId\n      }\n    });\n  }\n  resetFormState() {\n    this.existingRequest = null;\n    this.setFormMode('edit');\n    this.success = false;\n    this.error = '';\n    this.selectedFiles = {};\n    this.selectedSectors = [];\n    this.customSectorInput = '';\n    this.form.reset({\n      countryId: '',\n      countryName: '',\n      nsbOfficialName: '',\n      nsbAcronym: '',\n      isoCode: '',\n      contactPersonName: '',\n      contactPersonTitle: '',\n      contactEmail: '',\n      contactPhone: '',\n      contactMobile: '',\n      additionalUserSlotsRequested: 0,\n      requestedRoles: [],\n      sectors: []\n    });\n  }\n};\nNsbRegistrationRequestComponent = __decorate([Component({\n  selector: 'app-nsb-registration-request',\n  templateUrl: './nsb-registration-request.component.html',\n  styleUrls: ['./nsb-registration-request.component.scss']\n})], NsbRegistrationRequestComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}