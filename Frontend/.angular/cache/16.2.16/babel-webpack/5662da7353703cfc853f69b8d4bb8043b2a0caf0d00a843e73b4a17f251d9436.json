{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators } from '@angular/forms';\nimport { finalize } from 'rxjs';\nimport { NsbDocumentType } from '../../shared/models/nsb-registration-request.model';\nexport let NsbRegistrationRequestComponent = class NsbRegistrationRequestComponent {\n  constructor(fb, requestService, countryService, nsbService, router, authService) {\n    this.fb = fb;\n    this.requestService = requestService;\n    this.countryService = countryService;\n    this.nsbService = nsbService;\n    this.router = router;\n    this.authService = authService;\n    this.loading = false;\n    this.saving = false;\n    this.error = '';\n    this.success = false;\n    this.countries = [];\n    this.existingRequest = null;\n    this.activeTab = 'form';\n    this.registeredNsbs = [];\n    this.loadingNsbs = false;\n    this.documentTypes = [{\n      value: NsbDocumentType.NSB_ESTABLISHMENT_CHARTER,\n      label: 'NSB Establishment Charter/Act'\n    }, {\n      value: NsbDocumentType.ARSO_MEMBERSHIP_CERTIFICATE,\n      label: 'ARSO Membership Certificate'\n    }, {\n      value: NsbDocumentType.GOVERNMENT_GAZETTE_NOTICE,\n      label: 'Government Gazette Notice'\n    }, {\n      value: NsbDocumentType.DECLARATION_OF_AUTHORITY,\n      label: 'Declaration of Authority'\n    }];\n    this.selectedFiles = {};\n    this.sectorsOptions = [{\n      value: 'Food & Agriculture',\n      label: 'Food & Agriculture'\n    }, {\n      value: 'Telecommunications',\n      label: 'Telecommunications'\n    }, {\n      value: 'Non-Food',\n      label: 'Non-Food'\n    }, {\n      value: 'Energy',\n      label: 'Energy'\n    }, {\n      value: 'Health & Safety',\n      label: 'Health & Safety'\n    }, {\n      value: 'Environment',\n      label: 'Environment'\n    }, {\n      value: 'Construction',\n      label: 'Construction'\n    }, {\n      value: 'General Standards',\n      label: 'General Standards'\n    }, {\n      value: 'Other',\n      label: 'Other'\n    }];\n    this.selectedSectors = [];\n    this.requestedRolesOptions = [{\n      value: 'MARKET_SURVEILLANCE_OFFICER',\n      label: 'Market Surveillance Officer'\n    }, {\n      value: 'CERTIFICATION_LIAISON_OFFICER',\n      label: 'Certification Liaison Officer'\n    }, {\n      value: 'TRAINING_COORDINATOR',\n      label: 'Training Coordinator'\n    }, {\n      value: 'COMMUNICATIONS_OFFICER',\n      label: 'Communications Officer'\n    }];\n    this.form = this.fb.group({\n      countryId: ['', [Validators.required]],\n      countryName: [{\n        value: '',\n        disabled: true\n      }, [Validators.required]],\n      nsbOfficialName: ['', [Validators.required, Validators.maxLength(255)]],\n      nsbAcronym: ['', [Validators.maxLength(50)]],\n      isoCode: ['', [Validators.required, Validators.minLength(2), Validators.maxLength(2)]],\n      contactPersonName: ['', [Validators.required, Validators.maxLength(255)]],\n      contactPersonTitle: ['', [Validators.maxLength(255)]],\n      contactEmail: ['', [Validators.required, Validators.email, Validators.maxLength(255)]],\n      contactPhone: ['', [Validators.maxLength(50)]],\n      contactMobile: ['', [Validators.maxLength(50)]],\n      additionalUserSlotsRequested: [0, [Validators.min(0)]],\n      requestedRoles: [[]],\n      sectors: [[]]\n    });\n  }\n  ngOnInit() {\n    this.loadCountries();\n    this.checkExistingRequest();\n    this.setupCountryWatcher();\n    this.loadRegisteredNsbs();\n  }\n  loadRegisteredNsbs() {\n    this.loadingNsbs = true;\n    this.nsbService.getNsbList({\n      limit: 1000\n    }).subscribe({\n      next: response => {\n        this.registeredNsbs = (response.data || []).map(nsb => ({\n          id: nsb.id,\n          name: nsb.name,\n          countryName: nsb.country?.name || 'N/A',\n          status: nsb.status\n        }));\n        this.loadingNsbs = false;\n      },\n      error: err => {\n        // Don't show error for 403 - user might not have access\n        if (err.status !== 403 && err.status !== 404) {\n          console.warn('Failed to load registered NSBs:', err);\n        }\n        this.registeredNsbs = [];\n        this.loadingNsbs = false;\n      }\n    });\n  }\n  editNsb(nsbId) {\n    // Navigate to NSB dashboard or management\n    this.router.navigate(['/portal/nsb/dashboard']);\n  }\n  suspendNsb(nsbId) {\n    if (!confirm('Are you sure you want to suspend this NSB?')) {\n      return;\n    }\n    // TODO: Implement suspend functionality\n    console.log('Suspend NSB:', nsbId);\n  }\n  setupCountryWatcher() {\n    this.form.get('countryId')?.valueChanges.subscribe(countryId => {\n      const country = this.countries.find(c => c.id === countryId);\n      if (country) {\n        this.form.patchValue({\n          countryName: country.name,\n          isoCode: country.isoCode || ''\n        });\n      }\n    });\n  }\n  loadCountries() {\n    this.loading = true;\n    this.countryService.getCountries().pipe(finalize(() => {\n      this.loading = false;\n    })).subscribe({\n      next: data => {\n        this.countries = data;\n      },\n      error: () => {\n        this.error = 'Failed to load countries. Please try again.';\n      }\n    });\n  }\n  checkExistingRequest() {\n    const user = this.authService.currentUserValue;\n    if (user?.countryId) {\n      this.requestService.getMyRequest(user.countryId).subscribe({\n        next: request => {\n          if (request) {\n            this.existingRequest = request;\n            this.loadRequestData(request);\n          }\n        },\n        error: () => {\n          // No existing request, continue\n        }\n      });\n    }\n  }\n  loadRequestData(request) {\n    this.form.patchValue({\n      countryId: request.countryId,\n      countryName: request.countryName,\n      nsbOfficialName: request.nsbOfficialName,\n      nsbAcronym: request.nsbAcronym,\n      isoCode: request.isoCode,\n      contactPersonName: request.contactPersonName,\n      contactPersonTitle: request.contactPersonTitle,\n      contactEmail: request.contactEmail,\n      contactPhone: request.contactPhone,\n      contactMobile: request.contactMobile,\n      additionalUserSlotsRequested: request.additionalUserSlotsRequested || 0,\n      requestedRoles: request.requestedRoles || [],\n      sectors: request.sectors || []\n    });\n    this.selectedSectors = request.sectors || [];\n  }\n  onFileSelected(event, documentType) {\n    const input = event.target;\n    if (input.files && input.files[0]) {\n      const file = input.files[0];\n      // Validate file size (10MB max)\n      const maxSize = 10 * 1024 * 1024; // 10MB in bytes\n      if (file.size > maxSize) {\n        this.error = `File size exceeds 10MB limit. Please select a smaller file.`;\n        input.value = ''; // Clear the input\n        return;\n      }\n      // Validate file type\n      const allowedTypes = ['.pdf', '.doc', '.docx'];\n      const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();\n      if (!allowedTypes.includes(fileExtension)) {\n        this.error = `Invalid file type. Please upload PDF, DOC, or DOCX files only.`;\n        input.value = ''; // Clear the input\n        return;\n      }\n      this.selectedFiles[documentType] = file;\n      this.error = ''; // Clear any previous errors\n      // Upload file immediately if request exists\n      if (this.existingRequest?.id) {\n        this.uploadFile(documentType, file);\n      }\n    }\n  }\n  uploadFile(documentType, file) {\n    if (!this.existingRequest?.id) {\n      return;\n    }\n    this.requestService.uploadDocument(this.existingRequest.id, file, documentType).subscribe({\n      next: () => {\n        // File uploaded successfully, reload request to get updated documents\n        this.loadRequest();\n        // Clear the selected file since it's now uploaded\n        delete this.selectedFiles[documentType];\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to upload file. Please try again.';\n        // Don't delete selectedFiles here - user might want to retry\n      }\n    });\n  }\n\n  removeFile(documentType) {\n    if (!this.existingRequest?.id) {\n      delete this.selectedFiles[documentType];\n      return;\n    }\n    // Find document ID\n    const document = this.existingRequest.documents?.find(d => d.documentType === documentType);\n    if (document?.id) {\n      this.requestService.deleteDocument(this.existingRequest.id, document.id).subscribe({\n        next: () => {\n          delete this.selectedFiles[documentType];\n          this.loadRequest();\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to delete file. Please try again.';\n        }\n      });\n    } else {\n      delete this.selectedFiles[documentType];\n    }\n  }\n  loadRequest() {\n    if (!this.existingRequest?.id) {\n      return;\n    }\n    this.requestService.get(this.existingRequest.id).subscribe({\n      next: request => {\n        this.existingRequest = request;\n        this.loadRequestData(request);\n      },\n      error: () => {\n        // Error loading request\n      }\n    });\n  }\n  onSubmit() {\n    // Allow saving draft even if form is invalid\n    // Only mark fields as touched to show validation errors, but don't prevent saving\n    if (this.form.invalid) {\n      this.form.markAllAsTouched();\n      // Continue with save anyway for draft\n    }\n\n    this.saving = true;\n    this.error = '';\n    const formValue = this.form.getRawValue();\n    // Exclude documents from DTO - they are uploaded separately via file upload endpoint\n    const {\n      documents,\n      ...formDataWithoutDocuments\n    } = formValue;\n    const dto = {\n      ...formDataWithoutDocuments\n    };\n    const request$ = this.existingRequest ? this.requestService.update(this.existingRequest.id, dto) : this.requestService.create(dto);\n    request$.pipe(finalize(() => {\n      this.saving = false;\n    })).subscribe({\n      next: request => {\n        this.existingRequest = request;\n        this.success = true;\n        // Reload request to get updated documents\n        this.loadRequest();\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to save registration request. Please try again.';\n      }\n    });\n  }\n  onSubmitForReview() {\n    if (this.form.invalid) {\n      this.form.markAllAsTouched();\n      this.error = 'Please complete all required fields before submitting.';\n      return;\n    }\n    // First save the request if it doesn't exist\n    if (!this.existingRequest?.id) {\n      this.saving = true;\n      this.error = '';\n      const formValue = this.form.getRawValue();\n      const {\n        documents,\n        ...formDataWithoutDocuments\n      } = formValue;\n      const dto = {\n        ...formDataWithoutDocuments\n      };\n      this.requestService.create(dto).pipe(finalize(() => {\n        this.saving = false;\n      })).subscribe({\n        next: request => {\n          this.existingRequest = request;\n          // Upload any selected files that haven't been uploaded yet\n          this.uploadPendingFiles().then(() => {\n            // Reload request to get updated documents, then check and submit\n            this.loadRequest();\n            setTimeout(() => {\n              this.checkAndSubmitDocuments();\n            }, 500);\n          });\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to save registration request. Please try again.';\n        }\n      });\n      return;\n    }\n    // Upload any pending files first\n    this.uploadPendingFiles().then(() => {\n      // Reload request to get updated documents, then check and submit\n      this.loadRequest();\n      setTimeout(() => {\n        this.checkAndSubmitDocuments();\n      }, 500);\n    });\n  }\n  uploadPendingFiles() {\n    const uploadPromises = [];\n    const requiredDocs = [NsbDocumentType.NSB_ESTABLISHMENT_CHARTER, NsbDocumentType.ARSO_MEMBERSHIP_CERTIFICATE, NsbDocumentType.GOVERNMENT_GAZETTE_NOTICE, NsbDocumentType.DECLARATION_OF_AUTHORITY];\n    // Upload any selected files that haven't been uploaded yet\n    requiredDocs.forEach(docType => {\n      const file = this.selectedFiles[docType];\n      if (file && this.existingRequest?.id) {\n        // Check if this document type is already uploaded\n        const isAlreadyUploaded = this.existingRequest.documents?.some(d => d.documentType === docType);\n        if (!isAlreadyUploaded) {\n          const uploadPromise = new Promise((resolve, reject) => {\n            this.uploadFile(docType, file);\n            // Wait a bit for upload to complete\n            setTimeout(() => {\n              resolve();\n            }, 1000);\n          });\n          uploadPromises.push(uploadPromise);\n        }\n      }\n    });\n    return Promise.all(uploadPromises).then(() => {\n      // All uploads initiated, wait a bit more for them to complete\n      return new Promise(resolve => {\n        setTimeout(() => {\n          resolve();\n        }, 1500);\n      });\n    });\n  }\n  checkAndSubmitDocuments() {\n    // Check if required documents are uploaded\n    const requiredDocs = [NsbDocumentType.NSB_ESTABLISHMENT_CHARTER, NsbDocumentType.ARSO_MEMBERSHIP_CERTIFICATE, NsbDocumentType.GOVERNMENT_GAZETTE_NOTICE, NsbDocumentType.DECLARATION_OF_AUTHORITY];\n    // Reload request to ensure we have the latest documents\n    if (!this.existingRequest?.id) {\n      this.error = 'Please save the request first before submitting.';\n      return;\n    }\n    // Get fresh request data\n    this.requestService.get(this.existingRequest.id).subscribe({\n      next: request => {\n        this.existingRequest = request;\n        const uploadedDocTypes = request.documents?.map(d => d.documentType) || [];\n        const missingDocs = requiredDocs.filter(doc => !uploadedDocTypes.includes(doc));\n        if (missingDocs.length > 0) {\n          const missingLabels = missingDocs.map(doc => {\n            const docType = this.documentTypes.find(d => d.value === doc);\n            return docType?.label || doc;\n          });\n          this.error = `Please upload all required documents before submitting. Missing: ${missingLabels.join(', ')}`;\n          return;\n        }\n        // All documents uploaded, proceed with submission\n        this.saving = true;\n        this.requestService.submit(this.existingRequest.id).pipe(finalize(() => {\n          this.saving = false;\n        })).subscribe({\n          next: submittedRequest => {\n            this.existingRequest = submittedRequest;\n            this.success = true;\n            this.error = '';\n          },\n          error: err => {\n            this.error = err.error?.message || 'Failed to submit request. Please try again.';\n          }\n        });\n      },\n      error: () => {\n        this.error = 'Failed to load request. Please try again.';\n      }\n    });\n  }\n  getDocumentLabel(documentType) {\n    const doc = this.documentTypes.find(d => d.value === documentType);\n    return doc?.label || documentType;\n  }\n  getFileName(documentType) {\n    const file = this.selectedFiles[documentType];\n    return file ? file.name : '';\n  }\n  getUploadedDocument(documentType) {\n    return this.existingRequest?.documents?.find(d => d.documentType === documentType);\n  }\n  toggleRole(roleValue) {\n    const currentRoles = this.form.get('requestedRoles')?.value || [];\n    const index = currentRoles.indexOf(roleValue);\n    if (index > -1) {\n      currentRoles.splice(index, 1);\n    } else {\n      currentRoles.push(roleValue);\n    }\n    this.form.patchValue({\n      requestedRoles: currentRoles\n    });\n  }\n  toggleSector(sectorValue) {\n    const index = this.selectedSectors.indexOf(sectorValue);\n    if (index > -1) {\n      this.selectedSectors.splice(index, 1);\n    } else {\n      this.selectedSectors.push(sectorValue);\n    }\n    this.form.patchValue({\n      sectors: this.selectedSectors\n    });\n  }\n  isSectorSelected(sectorValue) {\n    return this.selectedSectors.includes(sectorValue);\n  }\n  viewDocument(documentType) {\n    const document = this.getUploadedDocument(documentType);\n    if (document?.id && this.existingRequest?.id) {\n      // Fetch document via HTTP client (includes auth headers) and open as blob URL\n      this.requestService.getDocumentBlob(this.existingRequest.id, document.id).subscribe({\n        next: blob => {\n          const url = URL.createObjectURL(blob);\n          window.open(url, '_blank');\n          // Clean up the blob URL after a delay (optional, but good practice)\n          setTimeout(() => URL.revokeObjectURL(url), 100);\n        },\n        error: err => {\n          this.error = err.error?.message || 'Failed to load document. Please try again.';\n        }\n      });\n    } else if (this.selectedFiles[documentType]) {\n      // Preview local file that hasn't been uploaded yet\n      const file = this.selectedFiles[documentType];\n      if (file) {\n        const url = URL.createObjectURL(file);\n        window.open(url, '_blank');\n      }\n    }\n  }\n};\nNsbRegistrationRequestComponent = __decorate([Component({\n  selector: 'app-nsb-registration-request',\n  templateUrl: './nsb-registration-request.component.html',\n  styleUrls: ['./nsb-registration-request.component.scss']\n})], NsbRegistrationRequestComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}