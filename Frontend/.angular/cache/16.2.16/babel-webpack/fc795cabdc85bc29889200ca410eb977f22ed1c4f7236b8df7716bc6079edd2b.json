{"ast":null,"code":"import { finalize, forkJoin } from 'rxjs';\nimport { RoleRequestStatus } from '../../shared/models/user.model';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../modules/auth/services/auth.service\";\nimport * as i2 from \"../../modules/nsb-management/services/nsb-registration-request.service\";\nimport * as i3 from \"@angular/forms\";\nexport let ApprovalsComponent = /*#__PURE__*/(() => {\n  class ApprovalsComponent {\n    constructor(authService, nsbService, fb) {\n      this.authService = authService;\n      this.nsbService = nsbService;\n      this.fb = fb;\n      this.activeTab = 'pending';\n      this.items = [];\n      this.filteredItems = [];\n      this.loading = false;\n      this.error = '';\n      // Modal Actions\n      this.selectedItem = null;\n      this.actionType = null;\n      this.decisionNote = '';\n      this.processing = false;\n      this.modalError = '';\n      this.modalSuccess = '';\n      this.filterForm = this.fb.group({\n        search: [''],\n        type: [''] // 'ROLE_REQUEST' or 'NSB_REGISTRATION'\n      });\n    }\n\n    ngOnInit() {\n      this.loadData();\n      this.setupFilters();\n    }\n    loadData() {\n      this.loading = true;\n      this.error = '';\n      forkJoin({\n        roleRequests: this.authService.listRoleRequests(),\n        nsbRequests: this.nsbService.list({\n          limit: 100\n        }) // Fetch reasonable amount\n      }).pipe(finalize(() => {\n        this.loading = false;\n      })).subscribe({\n        next: res => {\n          const roleItems = (res.roleRequests || []).map(r => this.mapRoleRequest(r));\n          const nsbItems = (res.nsbRequests.data || []).map(r => this.mapNsbRequest(r));\n          this.items = [...roleItems, ...nsbItems].sort((a, b) => new Date(b.submittedAt).getTime() - new Date(a.submittedAt).getTime());\n          this.applyFilters();\n        },\n        error: err => {\n          this.error = 'Failed to load approval requests.';\n          console.error(err);\n        }\n      });\n    }\n    mapRoleRequest(req) {\n      return {\n        id: req.id,\n        type: 'ROLE_REQUEST',\n        title: 'User Role Request',\n        subtitle: req.requestedRoles.join(', ').replace(/_/g, ' '),\n        requesterName: req.user?.fullName || 'Unknown User',\n        requesterEmail: req.user?.email || req.userId,\n        status: req.status,\n        submittedAt: req.createdAt,\n        reviewedBy: req.reviewedBy || undefined,\n        reviewedAt: req.reviewedAt || undefined,\n        notes: req.decisionNote || undefined,\n        originalRequest: req\n      };\n    }\n    mapNsbRequest(req) {\n      return {\n        id: req.id || '',\n        type: 'NSB_REGISTRATION',\n        title: 'NSB Registration',\n        subtitle: `${req.nsbOfficialName} (${req.countryName})`,\n        requesterName: req.contactPersonName,\n        requesterEmail: req.contactEmail,\n        status: req.status,\n        submittedAt: req.createdAt || '',\n        reviewedBy: req.reviewedBy,\n        reviewedAt: req.reviewedAt,\n        notes: req.remarks,\n        originalRequest: req\n      };\n    }\n    setupFilters() {\n      this.filterForm.valueChanges.subscribe(() => {\n        this.applyFilters();\n      });\n    }\n    applyFilters() {\n      const {\n        search,\n        type\n      } = this.filterForm.value;\n      const term = (search || '').toLowerCase();\n      // First filter by tab\n      let list = this.items.filter(item => {\n        if (this.activeTab === 'pending') {\n          return ['PENDING', 'SUBMITTED', 'UNDER_REVIEW', 'DRAFT'].includes(item.status);\n        } else {\n          return ['APPROVED', 'REJECTED'].includes(item.status);\n        }\n      });\n      // Then filter by search term\n      if (term) {\n        list = list.filter(item => item.title.toLowerCase().includes(term) || item.subtitle.toLowerCase().includes(term) || item.requesterName.toLowerCase().includes(term) || item.requesterEmail.toLowerCase().includes(term));\n      }\n      // Then filter by type\n      if (type) {\n        list = list.filter(item => item.type === type);\n      }\n      this.filteredItems = list;\n    }\n    setActiveTab(tab) {\n      this.activeTab = tab;\n      this.applyFilters();\n    }\n    // Actions\n    openDecisionModal(item, action) {\n      this.selectedItem = item;\n      this.actionType = action;\n      this.decisionNote = '';\n      this.modalError = '';\n      this.modalSuccess = '';\n    }\n    closeModal() {\n      this.selectedItem = null;\n      this.actionType = null;\n      this.decisionNote = '';\n    }\n    submitDecision() {\n      if (!this.selectedItem || !this.actionType) return;\n      this.processing = true;\n      this.modalError = '';\n      // Check type and call appropriate service\n      if (this.selectedItem.type === 'ROLE_REQUEST') {\n        const status = this.actionType === 'approve' ? RoleRequestStatus.APPROVED : RoleRequestStatus.REJECTED;\n        this.authService.decideRoleRequest(this.selectedItem.id, {\n          status,\n          note: this.decisionNote\n        }).pipe(finalize(() => this.processing = false)).subscribe({\n          next: () => this.handleSuccess(),\n          error: err => this.modalError = err.error?.message || 'Failed to process request.'\n        });\n      } else if (this.selectedItem.type === 'NSB_REGISTRATION') {\n        const obs = this.actionType === 'approve' ? this.nsbService.approve(this.selectedItem.id, this.decisionNote) : this.nsbService.reject(this.selectedItem.id, this.decisionNote);\n        obs.pipe(finalize(() => this.processing = false)).subscribe({\n          next: () => this.handleSuccess(),\n          error: err => this.modalError = err.error?.message || 'Failed to process request.'\n        });\n      }\n    }\n    handleSuccess() {\n      this.modalSuccess = 'Request processed successfully.';\n      setTimeout(() => {\n        this.closeModal();\n        this.loadData(); // Refresh list\n      }, 1500);\n    }\n    getStatusClass(status) {\n      switch (status) {\n        case 'APPROVED':\n          return 'bg-emerald-100 text-emerald-800';\n        case 'REJECTED':\n          return 'bg-rose-100 text-rose-800';\n        case 'PENDING':\n        case 'SUBMITTED':\n        case 'UNDER_REVIEW':\n          return 'bg-blue-100 text-blue-800';\n        default:\n          return 'bg-slate-100 text-slate-800';\n      }\n    }\n    getTypeLabel(type) {\n      return type === 'ROLE_REQUEST' ? 'Role Request' : 'NSB Registration';\n    }\n    static {\n      this.ɵfac = function ApprovalsComponent_Factory(t) {\n        return new (t || ApprovalsComponent)(i0.ɵɵdirectiveInject(i1.AuthService), i0.ɵɵdirectiveInject(i2.NsbRegistrationRequestService), i0.ɵɵdirectiveInject(i3.FormBuilder));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: ApprovalsComponent,\n        selectors: [[\"app-approvals\"]],\n        decls: 0,\n        vars: 0,\n        template: function ApprovalsComponent_Template(rf, ctx) {},\n        styles: [\"(()[_ngcontent-%COMP%]   =[_ngcontent-%COMP%] >  {// webpackBootstrap \\\"use strict\\\";})()[_ngcontent-%COMP%] ;{%BLOCK%}\"]\n      });\n    }\n  }\n  return ApprovalsComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}