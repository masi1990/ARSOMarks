{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { FormGroup, Validators, FormArray } from '@angular/forms';\nimport { ApplicationRegistrationStatus } from '../../shared/models/application-registration.model';\nimport { OperatorType, LegalStructure, EmployeeCountRange, AnnualTurnoverRange, OwnershipType, OwnershipStatus } from '../../shared/models/operator.model';\nexport let ApplicationRegistrationComponent = class ApplicationRegistrationComponent {\n  constructor(fb, applicationRegistrationService, countryService, router, route) {\n    this.fb = fb;\n    this.applicationRegistrationService = applicationRegistrationService;\n    this.countryService = countryService;\n    this.router = router;\n    this.route = route;\n    this.currentStep = 1;\n    this.totalSteps = 4;\n    this.loading = false;\n    this.saving = false;\n    this.error = '';\n    this.success = false;\n    this.draftSaveSuccess = false;\n    this.countries = [];\n    this.existingApplication = null;\n    this.currentYear = new Date().getFullYear();\n    // Options for dropdowns\n    this.operatorTypes = Object.values(OperatorType).map(value => ({\n      value,\n      label: value.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())\n    }));\n    this.legalStructures = Object.values(LegalStructure).map(value => ({\n      value,\n      label: value.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())\n    }));\n    this.employeeCountRanges = [{\n      value: EmployeeCountRange.MICRO_1_9,\n      label: 'Micro (1-9 employees)'\n    }, {\n      value: EmployeeCountRange.SMALL_10_49,\n      label: 'Small (10-49 employees)'\n    }, {\n      value: EmployeeCountRange.MEDIUM_50_249,\n      label: 'Medium (50-249 employees)'\n    }, {\n      value: EmployeeCountRange.LARGE_250_PLUS,\n      label: 'Large (250+ employees)'\n    }];\n    this.annualTurnoverRanges = [{\n      value: AnnualTurnoverRange.UNDER_50K,\n      label: '< $50K'\n    }, {\n      value: AnnualTurnoverRange['50K_100K'],\n      label: '$50K - $100K'\n    }, {\n      value: AnnualTurnoverRange['100K_500K'],\n      label: '$100K - $500K'\n    }, {\n      value: AnnualTurnoverRange['500K_1M'],\n      label: '$500K - $1M'\n    }, {\n      value: AnnualTurnoverRange['1M_5M'],\n      label: '$1M - $5M'\n    }, {\n      value: AnnualTurnoverRange['5M_10M'],\n      label: '$5M - $10M'\n    }, {\n      value: AnnualTurnoverRange.OVER_10M,\n      label: '> $10M'\n    }];\n    this.ownershipTypes = Object.values(OwnershipType).map(value => ({\n      value,\n      label: value.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())\n    }));\n    this.ownershipStatuses = Object.values(OwnershipStatus).map(value => ({\n      value,\n      label: value.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())\n    }));\n    this.mainBusinessSectors = ['AGRICULTURE', 'MANUFACTURING', 'SERVICES', 'CONSTRUCTION', 'MINING', 'RETAIL', 'WHOLESALE', 'TRANSPORT', 'ENERGY', 'TELECOMMUNICATIONS', 'OTHER'];\n    this.domesticMarketTypes = ['NATIONAL', 'REGIONAL', 'LOCAL'];\n    this.afcftaAwarenessLevels = ['HIGH', 'MEDIUM', 'LOW', 'NONE'];\n    this.qualityManagementOptions = ['YES', 'NO', 'IN_PROGRESS'];\n    this.qmsTypes = ['ISO_9001', 'HACCP', 'GMP', 'INTERNAL_SYSTEM', 'NONE', 'IN_PROGRESS'];\n    this.preferredLanguages = ['ENGLISH', 'FRENCH', 'PORTUGUESE', 'ARABIC', 'SWAHILI', 'OTHER'];\n    this.communicationPreferences = ['EMAIL', 'SMS', 'PHONE', 'WHATSAPP', 'POSTAL_MAIL', 'IN_PERSON'];\n    this.notificationFrequencies = ['REAL_TIME', 'DAILY_DIGEST', 'WEEKLY_SUMMARY', 'MONTHLY_SUMMARY'];\n    this.digitalLiteracyLevels = ['BASIC', 'INTERMEDIATE', 'ADVANCED'];\n    this.internetAccessTypes = ['HIGH_SPEED', 'MOBILE_DATA', 'LIMITED', 'INTERMITTENT'];\n    this.deviceTypes = ['DESKTOP', 'LAPTOP', 'SMARTPHONE', 'TABLET', 'FEATURE_PHONE'];\n    this.registrationForm = this.createForm();\n  }\n  ngOnInit() {\n    this.loadCountries();\n    this.route.queryParams.subscribe(params => {\n      const applicationId = params['id'];\n      if (applicationId) {\n        this.loadApplicationById(applicationId);\n      } else {\n        this.checkExistingApplication();\n      }\n    });\n    this.setupAutoCalculations();\n  }\n  loadApplicationById(id) {\n    this.applicationRegistrationService.getApplicationById(id).subscribe({\n      next: application => {\n        this.existingApplication = application;\n        this.loadApplicationData(application);\n      },\n      error: error => {\n        console.error('Error loading application:', error);\n        this.error = 'Failed to load application. Redirecting to list...';\n        setTimeout(() => {\n          this.router.navigate(['/application-registrations']);\n        }, 2000);\n      }\n    });\n  }\n  createForm() {\n    return this.fb.group({\n      // Section A: Company Info\n      companyInfo: this.fb.group({\n        operatorType: ['', Validators.required],\n        companyLegalName: ['', [Validators.required, Validators.minLength(2), Validators.maxLength(200)]],\n        tradingName: ['', Validators.maxLength(150)],\n        registrationNumberBusiness: ['', [Validators.required, Validators.maxLength(50)]],\n        taxId: ['', Validators.maxLength(30)],\n        vatNumber: ['', Validators.maxLength(30)],\n        yearEstablished: [this.currentYear, [Validators.required, Validators.min(1900), Validators.max(this.currentYear)]],\n        legalStructure: ['', Validators.required],\n        businessActivity: ['', [Validators.required, Validators.minLength(10), Validators.maxLength(500)]]\n      }),\n      // Section A: Company Size\n      companySize: this.fb.group({\n        employeeCount: ['', Validators.required],\n        annualTurnover: ['', Validators.required],\n        annualRevenue: [null, Validators.min(0)],\n        exportPercentage: [null, [Validators.min(0), Validators.max(100)]],\n        importPercentage: [null, [Validators.min(0), Validators.max(100)]],\n        capitalInvestment: [null, Validators.min(0)]\n      }),\n      // Section A: Ownership\n      ownershipInfo: this.fb.group({\n        ownershipType: ['', Validators.required],\n        majorityOwnerNationality: ['', Validators.maxLength(50)],\n        womenOwned: ['', Validators.required],\n        youthOwned: ['', Validators.required],\n        blackOwnedPercentage: [null, [Validators.min(0), Validators.max(100)]],\n        beneficialOwnersCount: [1, [Validators.required, Validators.min(1)]],\n        pepInvolved: [false, Validators.required],\n        pepDetails: ['', Validators.maxLength(500)]\n      }),\n      // Section B: Contact\n      primaryContact: this.fb.group({\n        primaryContact: ['', [Validators.required, Validators.minLength(3), Validators.maxLength(100)]],\n        contactPosition: ['', [Validators.required, Validators.minLength(2), Validators.maxLength(100)]],\n        contactEmail: ['', [Validators.required, Validators.email, Validators.maxLength(150)]],\n        contactPhone: ['', [Validators.required, Validators.maxLength(20)]],\n        altContact: ['', Validators.maxLength(100)],\n        altEmail: ['', [Validators.email, Validators.maxLength(150)]],\n        altPhone: ['', Validators.maxLength(20)]\n      }),\n      // Section B: Locations (Array)\n      locations: this.fb.array([this.createLocationFormGroup()]),\n      // Section C: Business Sectors (Array)\n      businessSectors: this.fb.array([this.createBusinessSectorFormGroup()]),\n      // Section C: Markets\n      marketInfo: this.fb.group({\n        domesticMarkets: [[], Validators.required],\n        exportMarkets: [[]],\n        primaryExportMarket: ['', Validators.required],\n        exportStartYear: [null, [Validators.min(1900), Validators.max(this.currentYear)]],\n        importSources: [[]],\n        afcftaAwareness: ['', Validators.required],\n        tradeChallenges: ['', Validators.maxLength(1000)]\n      }),\n      // Section C: Production Capacity\n      productionCapacity: this.fb.group({\n        productionCapacity: [null, [Validators.required, Validators.min(0)]],\n        capacityUnit: ['', [Validators.required, Validators.maxLength(20)]],\n        capacityUtilization: [null, [Validators.required, Validators.min(0), Validators.max(100)]],\n        qualityManagement: ['', Validators.required],\n        qmsType: ['', Validators.required],\n        certificationCount: [0, [Validators.required, Validators.min(0)]],\n        existingCertifications: ['', Validators.maxLength(1000)],\n        technicalStaff: [0, [Validators.required, Validators.min(0)]]\n      }),\n      // Section D: Preferences\n      preferences: this.fb.group({\n        preferredLanguage: ['ENGLISH', Validators.required],\n        communicationPreferences: [[], Validators.required],\n        notificationFrequency: ['DAILY_DIGEST', Validators.required],\n        timezone: ['', Validators.required],\n        currency: ['USD', Validators.required]\n      }),\n      // Section D: Accessibility\n      accessibility: this.fb.group({\n        assistiveTech: [false, Validators.required],\n        disabilityTypes: [[]],\n        specialAssistance: ['', Validators.maxLength(500)],\n        literacyLevel: ['BASIC', Validators.required],\n        internetAccess: ['', Validators.required],\n        deviceType: ['', Validators.required]\n      }),\n      // Section D: Consents\n      consents: this.fb.group({\n        dataConsent: [false, Validators.requiredTrue],\n        dataSharingConsent: [false, Validators.requiredTrue],\n        crossBorderData: [false, Validators.requiredTrue],\n        marketingConsent: [false],\n        smsConsent: [false],\n        whatsappConsent: [false],\n        termsAcceptance: [false, Validators.requiredTrue],\n        declarationSignature: ['', [Validators.required, Validators.minLength(3), Validators.maxLength(100)]]\n      }),\n      countryId: ['', Validators.required]\n    });\n  }\n  createLocationFormGroup() {\n    return this.fb.group({\n      locationType: ['REGISTERED_ADDRESS'],\n      physicalAddress: ['', [Validators.required, Validators.minLength(10), Validators.maxLength(500)]],\n      addressLine1: ['', [Validators.required, Validators.maxLength(100)]],\n      addressLine2: ['', Validators.maxLength(100)],\n      postalCode: ['', [Validators.required, Validators.maxLength(20)]],\n      cityTown: ['', [Validators.required, Validators.maxLength(100)]],\n      regionState: ['', [Validators.required, Validators.maxLength(100)]],\n      countryId: ['', Validators.required],\n      gpsCoordinates: ['', Validators.maxLength(50)],\n      factoryLocationSame: [null],\n      factoryName: ['', Validators.maxLength(200)],\n      factoryType: [''],\n      factorySize: [null, Validators.min(0)],\n      isPrimary: [true]\n    });\n  }\n  createBusinessSectorFormGroup() {\n    return this.fb.group({\n      mainSector: ['', Validators.required],\n      subSector: [[]],\n      isicCode: ['', Validators.maxLength(10)],\n      productCategories: [[]],\n      percentageRevenue: [null, [Validators.required, Validators.min(0), Validators.max(100)]],\n      sectorStartYear: [null, [Validators.min(1900), Validators.max(this.currentYear)]]\n    });\n  }\n  get locationsFormArray() {\n    return this.registrationForm.get('locations');\n  }\n  get businessSectorsFormArray() {\n    return this.registrationForm.get('businessSectors');\n  }\n  addLocation() {\n    this.locationsFormArray.push(this.createLocationFormGroup());\n  }\n  removeLocation(index) {\n    if (this.locationsFormArray.length > 1) {\n      this.locationsFormArray.removeAt(index);\n    }\n  }\n  addBusinessSector() {\n    this.businessSectorsFormArray.push(this.createBusinessSectorFormGroup());\n  }\n  removeBusinessSector(index) {\n    if (this.businessSectorsFormArray.length > 1) {\n      this.businessSectorsFormArray.removeAt(index);\n    }\n  }\n  loadCountries() {\n    this.countryService.getCountries().subscribe({\n      next: countries => {\n        this.countries = countries;\n      },\n      error: error => {\n        console.error('Error loading countries:', error);\n      }\n    });\n  }\n  checkExistingApplication() {\n    // Check if we're editing a specific application (from route params)\n    // Otherwise, load the most recent draft if available\n    this.applicationRegistrationService.getMyApplication().subscribe({\n      next: application => {\n        if (application) {\n          this.existingApplication = application;\n          if (application.status === ApplicationRegistrationStatus.DRAFT) {\n            this.loadApplicationData(application);\n          }\n        }\n      },\n      error: error => {\n        console.log('No existing application found');\n      }\n    });\n  }\n  loadApplicationData(application) {\n    // Load existing application data into form\n    // Handle both flat fields and nested JSON structures\n    const appData = application;\n    // Load nested structures\n    if (appData.companyInfo) {\n      this.registrationForm.get('companyInfo')?.patchValue(appData.companyInfo);\n    }\n    if (appData.companySize) {\n      this.registrationForm.get('companySize')?.patchValue(appData.companySize);\n    }\n    if (appData.ownershipInfo) {\n      this.registrationForm.get('ownershipInfo')?.patchValue(appData.ownershipInfo);\n    }\n    if (appData.primaryContact) {\n      this.registrationForm.get('primaryContact')?.patchValue(appData.primaryContact);\n    }\n    if (appData.marketInfo) {\n      this.registrationForm.get('marketInfo')?.patchValue(appData.marketInfo);\n    }\n    if (appData.productionCapacity) {\n      this.registrationForm.get('productionCapacity')?.patchValue(appData.productionCapacity);\n    }\n    if (appData.preferences) {\n      this.registrationForm.get('preferences')?.patchValue(appData.preferences);\n    }\n    if (appData.accessibility) {\n      this.registrationForm.get('accessibility')?.patchValue(appData.accessibility);\n    }\n    if (appData.consents) {\n      this.registrationForm.get('consents')?.patchValue(appData.consents);\n    }\n    if (application.countryId || appData.countryId) {\n      this.registrationForm.patchValue({\n        countryId: application.countryId || appData.countryId\n      });\n    }\n    // Load locations array\n    if (appData.locations && appData.locations.length > 0) {\n      // Clear existing locations\n      while (this.locationsFormArray.length > 0) {\n        this.locationsFormArray.removeAt(0);\n      }\n      // Add locations from data\n      appData.locations.forEach(loc => {\n        const locationGroup = this.createLocationFormGroup();\n        locationGroup.patchValue(loc);\n        this.locationsFormArray.push(locationGroup);\n      });\n    }\n    // Load business sectors array\n    if (appData.businessSectors && appData.businessSectors.length > 0) {\n      // Clear existing sectors\n      while (this.businessSectorsFormArray.length > 0) {\n        this.businessSectorsFormArray.removeAt(0);\n      }\n      // Add sectors from data\n      appData.businessSectors.forEach(sector => {\n        const sectorGroup = this.createBusinessSectorFormGroup();\n        sectorGroup.patchValue(sector);\n        this.businessSectorsFormArray.push(sectorGroup);\n      });\n    }\n  }\n  setupAutoCalculations() {\n    // Auto-calculate company age\n    this.registrationForm.get('companyInfo.yearEstablished')?.valueChanges.subscribe(year => {\n      if (year) {\n        const age = this.currentYear - year;\n        // Display only - not stored in form\n      }\n    });\n    // Validate revenue percentages sum to 100%\n    this.businessSectorsFormArray.valueChanges.subscribe(() => {\n      this.validateRevenuePercentages();\n    });\n  }\n  validateRevenuePercentages() {\n    const total = this.businessSectorsFormArray.controls.reduce((sum, control) => {\n      const percentage = control.get('percentageRevenue')?.value || 0;\n      return sum + percentage;\n    }, 0);\n    if (Math.abs(total - 100) > 0.01) {\n      this.businessSectorsFormArray.setErrors({\n        totalNot100: true\n      });\n    } else {\n      this.businessSectorsFormArray.setErrors(null);\n    }\n  }\n  /**\n   * Cleans form data by converting empty strings to undefined\n   */\n  cleanFormData(data) {\n    if (data === null || data === undefined) {\n      return undefined;\n    }\n    if (typeof data === 'string' && data.trim() === '') {\n      return undefined;\n    }\n    if (Array.isArray(data)) {\n      const cleaned = data.map(item => this.cleanFormData(item)).filter(item => item !== undefined);\n      return cleaned.length > 0 ? cleaned : undefined;\n    }\n    if (typeof data === 'object' && !(data instanceof Date)) {\n      const cleaned = {};\n      let hasValues = false;\n      for (const key in data) {\n        if (data.hasOwnProperty(key)) {\n          const cleanedValue = this.cleanFormData(data[key]);\n          if (cleanedValue !== undefined) {\n            cleaned[key] = cleanedValue;\n            hasValues = true;\n          }\n        }\n      }\n      return hasValues ? cleaned : undefined;\n    }\n    return data;\n  }\n  nextStep() {\n    if (this.isCurrentStepValid()) {\n      if (this.currentStep < this.totalSteps) {\n        this.currentStep++;\n      }\n    } else {\n      this.markFormGroupTouched(this.getCurrentStepFormGroup());\n    }\n  }\n  previousStep() {\n    if (this.currentStep > 1) {\n      this.currentStep--;\n    }\n  }\n  goToStep(step) {\n    if (step >= 1 && step <= this.totalSteps) {\n      this.currentStep = step;\n    }\n  }\n  isCurrentStepValid() {\n    const stepFormGroup = this.getCurrentStepFormGroup();\n    return stepFormGroup.valid;\n  }\n  getCurrentStepFormGroup() {\n    switch (this.currentStep) {\n      case 1:\n        return this.fb.group({\n          companyInfo: this.registrationForm.get('companyInfo'),\n          companySize: this.registrationForm.get('companySize'),\n          ownershipInfo: this.registrationForm.get('ownershipInfo'),\n          countryId: this.registrationForm.get('countryId')\n        });\n      case 2:\n        return this.fb.group({\n          primaryContact: this.registrationForm.get('primaryContact'),\n          locations: this.registrationForm.get('locations')\n        });\n      case 3:\n        return this.fb.group({\n          businessSectors: this.registrationForm.get('businessSectors'),\n          marketInfo: this.registrationForm.get('marketInfo'),\n          productionCapacity: this.registrationForm.get('productionCapacity')\n        });\n      case 4:\n        return this.fb.group({\n          preferences: this.registrationForm.get('preferences'),\n          accessibility: this.registrationForm.get('accessibility'),\n          consents: this.registrationForm.get('consents')\n        });\n      default:\n        return this.registrationForm;\n    }\n  }\n  markFormGroupTouched(formGroup) {\n    Object.keys(formGroup.controls).forEach(key => {\n      const control = formGroup.get(key);\n      control?.markAsTouched();\n      if (control instanceof FormGroup || control instanceof FormArray) {\n        this.markFormGroupTouched(control);\n      }\n    });\n  }\n  saveDraft() {\n    this.saving = true;\n    this.error = '';\n    this.success = false;\n    this.draftSaveSuccess = false;\n    const formValue = this.registrationForm.value;\n    const cleanedValue = this.cleanFormData(formValue);\n    if (this.existingApplication && this.existingApplication.id) {\n      this.applicationRegistrationService.updateApplication(this.existingApplication.id, cleanedValue).subscribe({\n        next: application => {\n          this.existingApplication = application;\n          this.saving = false;\n          this.draftSaveSuccess = true;\n          // Show notification for 5 seconds\n          setTimeout(() => {\n            this.draftSaveSuccess = false;\n          }, 5000);\n        },\n        error: error => {\n          this.saving = false;\n          this.error = error.error?.message || 'Failed to save draft. Please try again.';\n          setTimeout(() => {\n            this.error = '';\n          }, 5000);\n        }\n      });\n    } else {\n      this.applicationRegistrationService.saveDraft(cleanedValue).subscribe({\n        next: application => {\n          this.existingApplication = application;\n          this.saving = false;\n          this.draftSaveSuccess = true;\n          // Show notification for 5 seconds\n          setTimeout(() => {\n            this.draftSaveSuccess = false;\n          }, 5000);\n        },\n        error: error => {\n          this.saving = false;\n          this.error = error.error?.message || 'Failed to save draft. Please try again.';\n          setTimeout(() => {\n            this.error = '';\n          }, 5000);\n        }\n      });\n    }\n  }\n  onSubmit() {\n    if (this.registrationForm.invalid) {\n      this.markFormGroupTouched(this.registrationForm);\n      this.error = 'Please fill in all required fields correctly';\n      return;\n    }\n    this.validateRevenuePercentages();\n    if (this.businessSectorsFormArray.errors?.['totalNot100']) {\n      this.error = 'Total revenue percentage across all sectors must equal 100%';\n      return;\n    }\n    this.loading = true;\n    this.error = '';\n    const formValue = this.registrationForm.value;\n    const cleanedValue = this.cleanFormData(formValue);\n    if (this.existingApplication && this.existingApplication.id) {\n      this.applicationRegistrationService.updateApplication(this.existingApplication.id, cleanedValue).subscribe({\n        next: application => {\n          this.existingApplication = application;\n          this.submitApplication(application.id);\n        },\n        error: error => {\n          this.loading = false;\n          this.error = error.error?.message || 'Failed to update registration';\n        }\n      });\n    } else {\n      this.applicationRegistrationService.createApplicationRegistration(cleanedValue).subscribe({\n        next: application => {\n          this.existingApplication = application;\n          this.submitApplication(application.id);\n        },\n        error: error => {\n          this.loading = false;\n          this.error = error.error?.message || 'Failed to create registration';\n        }\n      });\n    }\n  }\n  submitApplication(applicationId) {\n    this.applicationRegistrationService.submitApplication(applicationId).subscribe({\n      next: () => {\n        this.loading = false;\n        this.success = true;\n        setTimeout(() => {\n          this.router.navigate(['/application-registrations']);\n        }, 2000);\n      },\n      error: error => {\n        this.loading = false;\n        this.error = error.error?.message || 'Failed to submit registration';\n      }\n    });\n  }\n  getStepTitle(step) {\n    const titles = {\n      1: 'Company Information',\n      2: 'Contact & Location',\n      3: 'Business Activities',\n      4: 'Preferences & Consent'\n    };\n    return titles[step] || '';\n  }\n  formatEnumLabel(value) {\n    return value.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n  }\n};\nApplicationRegistrationComponent = __decorate([Component({\n  selector: 'app-application-registration',\n  templateUrl: './application-registration.component.html',\n  styleUrls: ['./application-registration.component.scss']\n})], ApplicationRegistrationComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}