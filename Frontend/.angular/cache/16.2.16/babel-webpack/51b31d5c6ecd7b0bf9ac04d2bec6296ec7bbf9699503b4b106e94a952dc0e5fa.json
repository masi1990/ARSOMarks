{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { finalize } from 'rxjs';\nimport { RoleRequestStatus, UserRole } from '../../shared/models/user.model';\nexport let DashboardComponent = class DashboardComponent {\n  constructor(authService) {\n    this.authService = authService;\n    this.user = null;\n    this.roleRequests = [];\n    this.allRequests = [];\n    this.loadingRequests = false;\n    this.loadingAllRequests = false;\n    this.submitting = false;\n    this.submitError = '';\n    this.submitSuccess = '';\n    this.decisionError = '';\n    this.decisionSuccess = '';\n    this.note = '';\n    this.selectedRoles = [];\n    this.decidingId = null;\n    this.decisionNote = '';\n    this.decidingRequestId = null;\n    // Pagination for Approver Console\n    this.approvalsPage = 1;\n    this.approvalsPageSize = 4;\n    this.roleOptions = Object.values(UserRole).map(r => ({\n      value: r,\n      label: r.replace(/_/g, ' ')\n    }));\n  }\n  loadRequests() {\n    this.loadingRequests = true;\n    this.authService.getMyRoleRequests().pipe(finalize(() => {\n      this.loadingRequests = false;\n    })).subscribe({\n      next: reqs => {\n        this.roleRequests = reqs || [];\n      },\n      error: () => {\n        this.roleRequests = [];\n      }\n    });\n  }\n  loadAllRequests() {\n    this.loadingAllRequests = true;\n    this.authService.listRoleRequests().pipe(finalize(() => {\n      this.loadingAllRequests = false;\n    })).subscribe({\n      next: reqs => {\n        this.allRequests = reqs || [];\n      },\n      error: () => {\n        this.allRequests = [];\n      }\n    });\n  }\n  // Pagination Getters & Methods\n  get paginatedApprovals() {\n    const start = (this.approvalsPage - 1) * this.approvalsPageSize;\n    return this.allRequests.slice(start, start + this.approvalsPageSize);\n  }\n  get totalApprovalPages() {\n    return Math.ceil(this.allRequests.length / this.approvalsPageSize) || 1;\n  }\n  nextApprovalPage() {\n    if (this.approvalsPage < this.totalApprovalPages) {\n      this.approvalsPage++;\n    }\n  }\n  prevApprovalPage() {\n    if (this.approvalsPage > 1) {\n      this.approvalsPage--;\n    }\n  }\n  refreshProfile() {\n    this.authService.getProfile().subscribe({\n      next: user => {\n        this.user = user;\n        // If the freshly fetched profile has approver roles, ensure approver data loads.\n        if (this.isApprover() && !this.allRequests.length) {\n          this.loadAllRequests();\n        }\n      },\n      error: () => {\n        // Ignore profile errors here; fall back to the cached user.\n      }\n    });\n  }\n  submitRoleRequest() {\n    this.submitError = '';\n    this.submitSuccess = '';\n    if (!this.selectedRoles.length) {\n      this.submitError = 'Select at least one role.';\n      return;\n    }\n    const payload = {\n      roles: this.selectedRoles,\n      note: this.note?.trim() || undefined\n    };\n    this.submitting = true;\n    this.authService.requestRoles(payload).pipe(finalize(() => {\n      this.submitting = false;\n    })).subscribe({\n      next: res => {\n        this.submitSuccess = 'Request submitted. You will be notified after review.';\n        this.selectedRoles = [];\n        this.note = '';\n        this.roleRequests = [res, ...this.roleRequests];\n      },\n      error: err => {\n        this.submitError = err?.error?.message || 'Failed to submit request.';\n      }\n    });\n  }\n  openDecisionModal(id) {\n    this.decidingRequestId = id;\n    this.decisionNote = '';\n    this.decisionError = '';\n    this.decisionSuccess = '';\n  }\n  closeDecisionModal() {\n    this.decidingRequestId = null;\n    this.decisionNote = '';\n    this.decisionError = '';\n    this.decisionSuccess = '';\n  }\n  decide(id, status) {\n    this.decisionError = '';\n    this.decisionSuccess = '';\n    this.decidingId = id;\n    const payload = {\n      status,\n      note: this.decisionNote?.trim() || undefined\n    };\n    this.authService.decideRoleRequest(id, payload).pipe(finalize(() => {\n      this.decidingId = null;\n      this.closeDecisionModal();\n    })).subscribe({\n      next: res => {\n        this.decisionSuccess = `Request ${status.toLowerCase()}.`;\n        this.allRequests = this.allRequests.map(r => r.id === res.id ? res : r);\n        if (res.userId === this.user?.id) {\n          this.roleRequests = this.roleRequests.map(r => r.id === res.id ? res : r);\n        }\n        // Reset pagination if needed\n        if (this.approvalsPage > this.totalApprovalPages) {\n          this.approvalsPage = Math.max(1, this.totalApprovalPages);\n        }\n      },\n      error: err => {\n        this.decisionError = err?.error?.message || 'Action failed.';\n      }\n    });\n  }\n  toggleRole(role) {\n    if (this.selectedRoles.includes(role)) {\n      this.selectedRoles = this.selectedRoles.filter(r => r !== role);\n    } else {\n      this.selectedRoles = [...this.selectedRoles, role];\n    }\n  }\n  formatRole(role) {\n    return (role || '').toString().replace(/_/g, ' ');\n  }\n  formatRolesList(roles) {\n    return roles && roles.length ? roles.map(r => this.formatRole(r)).join(', ') : 'None';\n  }\n  statusBadgeClasses(status) {\n    switch (status) {\n      case RoleRequestStatus.APPROVED:\n        return 'bg-emerald-50 text-emerald-700';\n      case RoleRequestStatus.REJECTED:\n        return 'bg-rose-50 text-rose-700';\n      default:\n        return 'bg-amber-50 text-amber-700';\n    }\n  }\n  isApprover() {\n    const roles = this.user?.roles || (this.user?.role ? [this.user.role] : []);\n    return roles.includes(UserRole.SUPER_ADMIN) || roles.includes(UserRole.ARSO_SECRETARIAT);\n  }\n  isNsbAdmin() {\n    const roles = this.user?.roles || (this.user?.role ? [this.user.role] : []);\n    return roles.includes(UserRole.NSB_ADMIN) || roles.includes(UserRole.NSB_USER);\n  }\n  ngOnInit() {\n    this.user = this.authService.currentUserValue;\n    this.loadRequests();\n    if (this.isApprover()) {\n      this.loadAllRequests();\n    }\n    // Always refresh the profile to pick up latest roles (e.g., newly granted SUPER_ADMIN).\n    // Use setTimeout to avoid blocking initial render\n    setTimeout(() => {\n      this.refreshProfile();\n    }, 0);\n  }\n};\nDashboardComponent = __decorate([Component({\n  selector: 'app-dashboard',\n  templateUrl: './dashboard.component.html',\n  styleUrls: ['./dashboard.component.scss']\n})], DashboardComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}