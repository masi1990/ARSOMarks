{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators } from '@angular/forms';\nimport { finalize } from 'rxjs/operators';\nimport { LicenseDurationType, MarkLicenseType } from 'src/app/shared/models/mark-license.model';\nimport { UserRole } from 'src/app/shared/models/user.model';\nexport let MarkLicenseApplicationComponent = class MarkLicenseApplicationComponent {\n  constructor(fb, nsbService, authService, licenseService, router) {\n    this.fb = fb;\n    this.nsbService = nsbService;\n    this.authService = authService;\n    this.licenseService = licenseService;\n    this.router = router;\n    this.currentStep = 1;\n    this.nsbOptions = [];\n    this.selectedNsb = null;\n    this.loading = false;\n    this.loadingNsbs = false;\n    this.saving = false;\n    this.submitting = false;\n    this.error = '';\n    this.existingApplication = null;\n    this.initForm();\n  }\n  ngOnInit() {\n    this.loadNsbs();\n  }\n  initForm() {\n    this.applicationForm = this.fb.group({\n      nsbId: ['', Validators.required],\n      // License Types - Default unchecked\n      promotionalLicense: [false],\n      certificationBodyLicense: [false],\n      specialProjectLicense: [false],\n      // Section C Compliance - Default unchecked\n      agreementCompliance: [false, Validators.requiredTrue],\n      markUsageCompliance: [false, Validators.requiredTrue],\n      misleadingStatementsCompliance: [false, Validators.requiredTrue],\n      changesCompliance: [false, Validators.requiredTrue]\n    });\n  }\n  loadNsbs() {\n    this.loadingNsbs = true;\n    const user = this.authService.currentUserValue;\n    const userRoles = user?.roles || (user?.role ? [user.role] : []);\n    const isAdmin = userRoles.includes(UserRole.SUPER_ADMIN) || userRoles.includes(UserRole.ARSO_SECRETARIAT);\n    const request = isAdmin ? this.nsbService.getNsbList({\n      limit: 1000\n    }) : user?.countryId ? this.nsbService.getNsbList({\n      countryId: user.countryId,\n      limit: 1000\n    }) : this.nsbService.getMyNsb();\n    request.pipe(finalize(() => {\n      this.loadingNsbs = false;\n    })).subscribe({\n      next: response => {\n        const options = Array.isArray(response) ? response : response?.data ? response.data : response ? [response] : [];\n        this.nsbOptions = options || [];\n        if (this.nsbOptions.length === 1) {\n          this.onNsbChange(this.nsbOptions[0].id);\n        }\n      },\n      error: () => {\n        this.error = 'Unable to load NSB list.';\n      }\n    });\n  }\n  onNsbChange(nsbId) {\n    const selected = this.nsbOptions.find(nsb => nsb.id === nsbId) || null;\n    this.selectedNsb = selected;\n    this.applicationForm.patchValue({\n      nsbId: nsbId || ''\n    });\n  }\n  goToStep(step) {\n    if (step < this.currentStep) {\n      this.currentStep = step;\n    } else {\n      if (!this.isStepValid(this.currentStep)) {\n        return;\n      }\n      this.currentStep = step;\n    }\n  }\n  nextStep() {\n    this.goToStep(this.currentStep + 1);\n  }\n  prevStep() {\n    this.goToStep(this.currentStep - 1);\n  }\n  saveDraft() {\n    if (!this.applicationForm.get('nsbId')?.value) {\n      this.error = 'NSB profile is required before saving a draft.';\n      return;\n    }\n    this.saving = true;\n    this.error = '';\n    const payload = this.buildPayload();\n    const operation = this.existingApplication ? this.licenseService.updateApplication(this.existingApplication.id, payload) : this.licenseService.createApplication(payload);\n    operation.pipe(finalize(() => {\n      this.saving = false;\n    })).subscribe({\n      next: application => {\n        this.existingApplication = application;\n      },\n      error: () => {\n        this.error = 'Failed to save draft.';\n      }\n    });\n  }\n  submitApplication() {\n    if (!this.isStepValid(3)) {\n      return;\n    }\n    if (!this.existingApplication) {\n      this.error = 'Please save the application as draft first.';\n      return;\n    }\n    this.submitting = true;\n    this.error = '';\n    this.licenseService.submitApplication(this.existingApplication.id).pipe(finalize(() => {\n      this.submitting = false;\n    })).subscribe({\n      next: () => {\n        this.router.navigate(['/portal/mark-licenses/dashboard']);\n      },\n      error: () => {\n        this.error = 'Failed to submit application.';\n      }\n    });\n  }\n  buildPayload() {\n    return {\n      nsbId: this.applicationForm.get('nsbId')?.value || '',\n      licenseTypes: this.getSelectedLicenseTypes(),\n      licenseDuration: LicenseDurationType.OTHER,\n      licenseDurationOther: '',\n      marksRequested: [],\n      annexBCompliance: this.applicationForm.get('agreementCompliance')?.value ?? false,\n      brandGuidelinesAck: this.applicationForm.get('markUsageCompliance')?.value ?? false,\n      modificationPolicyAcceptance: this.applicationForm.get('misleadingStatementsCompliance')?.value ?? false,\n      declarationSignatory: '',\n      signatoryTitle: '',\n      signatoryEmail: '',\n      auditRightsAcceptance: this.applicationForm.get('changesCompliance')?.value ?? false,\n      annualReportingCommitment: false,\n      dataSharingConsent: false\n    };\n  }\n  getSelectedLicenseTypes() {\n    const selected = [];\n    if (this.applicationForm.get('promotionalLicense')?.value) {\n      selected.push(MarkLicenseType.PROMOTIONAL_INSTITUTIONAL);\n    }\n    if (this.applicationForm.get('certificationBodyLicense')?.value) {\n      selected.push(MarkLicenseType.CERTIFICATION_BODY);\n    }\n    if (this.applicationForm.get('specialProjectLicense')?.value) {\n      selected.push(MarkLicenseType.SPECIAL_PROJECT);\n    }\n    return selected;\n  }\n  isStepValid(step) {\n    if (step === 1) {\n      const nsbId = this.applicationForm.get('nsbId')?.value;\n      if (!nsbId) {\n        this.error = 'Select an NSB to continue.';\n        return false;\n      }\n    }\n    if (step === 2) {\n      if (this.getSelectedLicenseTypes().length === 0) {\n        this.error = 'Select at least one license type to continue.';\n        return false;\n      }\n    }\n    if (step === 3) {\n      const requirementsMet = this.applicationForm.get('agreementCompliance')?.value && this.applicationForm.get('markUsageCompliance')?.value && this.applicationForm.get('misleadingStatementsCompliance')?.value && this.applicationForm.get('changesCompliance')?.value;\n      if (!requirementsMet) {\n        this.error = 'Please confirm all mark usage requirements.';\n        return false;\n      }\n    }\n    this.error = '';\n    return true;\n  }\n};\nMarkLicenseApplicationComponent = __decorate([Component({\n  selector: 'app-mark-license-application',\n  templateUrl: './mark-license-application.component.html',\n  styleUrls: ['./mark-license-application.component.scss']\n})], MarkLicenseApplicationComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}