{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { finalize } from 'rxjs';\nimport { RoleRequestStatus, UserRole } from '../../shared/models/user.model';\nexport let DashboardComponent = class DashboardComponent {\n  constructor(authService) {\n    this.authService = authService;\n    this.user = null;\n    this.roleRequests = [];\n    this.pendingRequests = [];\n    this.allRequests = [];\n    this.loadingRequests = false;\n    this.loadingAllRequests = false;\n    this.submitting = false;\n    this.submitError = '';\n    this.submitSuccess = '';\n    this.decisionError = '';\n    this.decisionSuccess = '';\n    this.note = '';\n    this.selectedRoles = new Set();\n    this.disabledRoles = new Set();\n    this.decidingId = null;\n    this.decisionNote = '';\n    this.decidingRequestId = null;\n    this.pendingAction = null;\n    // Pagination for Approver Console\n    this.approvalsPage = 1;\n    this.approvalsPageSize = 4;\n    this.roleCards = [{\n      value: UserRole.OPERATOR,\n      title: 'Manufacturer / Operator',\n      blurb: 'Request marks, manage products, track certifications.',\n      badge: 'Producers & Operators'\n    }, {\n      value: UserRole.CB_ADMIN,\n      title: 'Certification Body',\n      blurb: 'Plan audits, issue CoCs, oversee certificate lifecycle.',\n      badge: 'CB / Laboratory'\n    }, {\n      value: UserRole.NSB_ADMIN,\n      title: 'National Standards Body',\n      blurb: 'Coordinate approvals, registry oversight, market surveillance.',\n      badge: 'NSB'\n    }];\n    // Expose Math for template\n    this.Math = Math;\n  }\n  loadRequests() {\n    this.loadingRequests = true;\n    this.authService.getMyRoleRequests().pipe(finalize(() => {\n      this.loadingRequests = false;\n    })).subscribe({\n      next: reqs => {\n        this.roleRequests = reqs || [];\n        this.pendingRequests = this.roleRequests.filter(r => r.status === RoleRequestStatus.PENDING);\n        this.updateDisabledRoles();\n      },\n      error: () => {\n        this.roleRequests = [];\n        this.pendingRequests = [];\n        this.updateDisabledRoles();\n      }\n    });\n  }\n  loadAllRequests() {\n    this.loadingAllRequests = true;\n    this.authService.listRoleRequests().pipe(finalize(() => {\n      this.loadingAllRequests = false;\n    })).subscribe({\n      next: reqs => {\n        this.allRequests = reqs || [];\n      },\n      error: () => {\n        this.allRequests = [];\n      }\n    });\n  }\n  // Pagination Getters & Methods\n  get paginatedApprovals() {\n    const start = (this.approvalsPage - 1) * this.approvalsPageSize;\n    return this.allRequests.slice(start, start + this.approvalsPageSize);\n  }\n  get totalApprovalPages() {\n    return Math.ceil(this.allRequests.length / this.approvalsPageSize) || 1;\n  }\n  nextApprovalPage() {\n    if (this.approvalsPage < this.totalApprovalPages) {\n      this.approvalsPage++;\n    }\n  }\n  prevApprovalPage() {\n    if (this.approvalsPage > 1) {\n      this.approvalsPage--;\n    }\n  }\n  get decidingRequest() {\n    if (!this.decidingRequestId) return null;\n    return this.allRequests.find(r => r.id === this.decidingRequestId) || null;\n  }\n  get pendingRequestsCount() {\n    return this.roleRequests.filter(r => r.status === RoleRequestStatus.PENDING).length;\n  }\n  refreshProfile() {\n    this.authService.getProfile().subscribe({\n      next: user => {\n        this.user = user;\n        // If the freshly fetched profile has approver roles, ensure approver data loads.\n        if (this.isApprover() && !this.allRequests.length) {\n          this.loadAllRequests();\n        }\n      },\n      error: () => {\n        // Ignore profile errors here; fall back to the cached user.\n      }\n    });\n  }\n  submitRoleRequest() {\n    this.submitError = '';\n    this.submitSuccess = '';\n    if (!this.selectedRoles.size) {\n      this.submitError = 'Select at least one role.';\n      return;\n    }\n    const payload = {\n      requestedRoles: Array.from(this.selectedRoles),\n      note: this.note?.trim() || undefined\n    };\n    this.submitting = true;\n    this.authService.requestRoles(payload).pipe(finalize(() => {\n      this.submitting = false;\n    })).subscribe({\n      next: res => {\n        const created = Array.isArray(res) ? res : [res];\n        this.submitSuccess = 'Request submitted. You will be notified after review.';\n        this.selectedRoles = new Set();\n        this.note = '';\n        this.roleRequests = [...created, ...this.roleRequests];\n        this.pendingRequests = this.roleRequests.filter(r => r.status === RoleRequestStatus.PENDING);\n        this.updateDisabledRoles();\n      },\n      error: err => {\n        this.submitError = err?.error?.message || 'Failed to submit request.';\n      }\n    });\n  }\n  openDecisionModal(id, action) {\n    this.decidingRequestId = id;\n    this.pendingAction = action;\n    this.decisionNote = '';\n    this.decisionError = '';\n    this.decisionSuccess = '';\n  }\n  closeDecisionModal() {\n    this.decidingRequestId = null;\n    this.pendingAction = null;\n    this.decisionNote = '';\n    this.decisionError = '';\n    this.decisionSuccess = '';\n  }\n  confirmDecision() {\n    if (!this.decidingRequestId || !this.pendingAction) return;\n    const status = this.pendingAction === 'approve' ? RoleRequestStatus.APPROVED : RoleRequestStatus.REJECTED;\n    this.decide(this.decidingRequestId, status);\n  }\n  decide(id, status) {\n    this.decisionError = '';\n    this.decisionSuccess = '';\n    this.decidingId = id;\n    const payload = {\n      status,\n      note: this.decisionNote?.trim() || undefined\n    };\n    this.authService.decideRoleRequest(id, payload).pipe(finalize(() => {\n      this.decidingId = null;\n      this.closeDecisionModal();\n    })).subscribe({\n      next: res => {\n        this.decisionSuccess = `Request ${status.toLowerCase()}.`;\n        this.allRequests = this.allRequests.map(r => r.id === res.id ? res : r);\n        if (res.userId === this.user?.id) {\n          this.roleRequests = this.roleRequests.map(r => r.id === res.id ? res : r);\n        }\n        // Reset pagination if needed\n        if (this.approvalsPage > this.totalApprovalPages) {\n          this.approvalsPage = Math.max(1, this.totalApprovalPages);\n        }\n      },\n      error: err => {\n        this.decisionError = err?.error?.message || 'Action failed.';\n      }\n    });\n  }\n  toggleRole(role) {\n    if (this.disabledRoles.has(role)) return;\n    if (this.selectedRoles.has(role)) {\n      this.selectedRoles.delete(role);\n    } else {\n      this.selectedRoles.add(role);\n    }\n    // Ensure change detection picks up Set mutation\n    this.selectedRoles = new Set(this.selectedRoles);\n  }\n  isSelected(role) {\n    return this.selectedRoles.has(role);\n  }\n  clearSelection() {\n    this.selectedRoles = new Set();\n  }\n  hasPendingFor(role) {\n    return this.pendingRequests.some(req => req.status === RoleRequestStatus.PENDING && req.requestedRoles.includes(role));\n  }\n  formatRole(role) {\n    return (role || '').toString().replace(/_/g, ' ');\n  }\n  formatRolesList(roles) {\n    return roles && roles.length ? roles.map(r => this.formatRole(r)).join(', ') : 'None';\n  }\n  statusBadgeClasses(status) {\n    switch (status) {\n      case RoleRequestStatus.APPROVED:\n        return 'bg-emerald-50 text-emerald-700';\n      case RoleRequestStatus.REJECTED:\n        return 'bg-rose-50 text-rose-700';\n      default:\n        return 'bg-amber-50 text-amber-700';\n    }\n  }\n  isApprover() {\n    const roles = this.user?.roles || (this.user?.role ? [this.user.role] : []);\n    return roles.includes(UserRole.SUPER_ADMIN) || roles.includes(UserRole.ARSO_SECRETARIAT);\n  }\n  isNsbAdmin() {\n    const roles = this.getUserRoles();\n    return roles.includes(UserRole.NSB_ADMIN) || roles.includes(UserRole.NSB_USER);\n  }\n  isOperator() {\n    const roles = this.getUserRoles();\n    return roles.includes(UserRole.OPERATOR) || roles.includes(UserRole.NSB_ADMIN) || roles.includes(UserRole.SUPER_ADMIN) || roles.includes(UserRole.PUBLIC);\n  }\n  isCbUser() {\n    const roles = this.getUserRoles();\n    return roles.includes(UserRole.CB_ADMIN) || roles.includes(UserRole.CB_USER) || roles.includes(UserRole.SUPER_ADMIN) || roles.includes(UserRole.ARSO_SECRETARIAT) || roles.includes(UserRole.PUBLIC);\n  }\n  isPublic() {\n    const roles = this.getUserRoles();\n    return roles.includes(UserRole.PUBLIC);\n  }\n  canSeeTools() {\n    return !!this.user;\n  }\n  getUserRoles() {\n    return this.user?.roles || (this.user?.role ? [this.user.role] : []);\n  }\n  updateDisabledRoles() {\n    const owned = this.getUserRoles();\n    const pending = this.pendingRequests.flatMap(r => r.requestedRoles || []);\n    this.disabledRoles = new Set([...owned, ...pending]);\n  }\n  ngOnInit() {\n    this.user = this.authService.currentUserValue;\n    this.loadRequests();\n    if (this.isApprover()) {\n      this.loadAllRequests();\n    }\n    // Always refresh the profile to pick up latest roles (e.g., newly granted SUPER_ADMIN).\n    // Use setTimeout to avoid blocking initial render\n    setTimeout(() => {\n      this.refreshProfile();\n    }, 0);\n  }\n};\nDashboardComponent = __decorate([Component({\n  selector: 'app-dashboard',\n  templateUrl: './dashboard.component.html',\n  styleUrls: ['./dashboard.component.scss']\n})], DashboardComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}