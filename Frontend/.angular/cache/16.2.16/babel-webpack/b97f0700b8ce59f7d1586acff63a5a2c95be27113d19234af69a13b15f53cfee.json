{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators } from '@angular/forms';\nimport { finalize } from 'rxjs';\nimport { NsbProfileDocumentType } from '../../shared/models/nsb.model';\nimport { NsbRegistrationRequestStatus } from '../../shared/models/nsb-registration-request.model';\nexport let NsbProfileSetupComponent = class NsbProfileSetupComponent {\n  constructor(fb, nsbService, countryService, requestService, router, authService) {\n    this.fb = fb;\n    this.nsbService = nsbService;\n    this.countryService = countryService;\n    this.requestService = requestService;\n    this.router = router;\n    this.authService = authService;\n    this.loading = false;\n    this.saving = false;\n    this.error = '';\n    this.success = false;\n    this.successMessage = '';\n    this.nsb = null;\n    this.registrationRequest = null;\n    this.countries = [];\n    // Document uploads\n    this.selectedDocuments = {};\n    this.uploadedDocuments = [];\n    // Location management\n    this.locations = [];\n    this.editingLocationIndex = null;\n    this.showLocationForm = false;\n    // Contact management\n    this.editingContact = null;\n    this.deletingContact = null;\n    // Document types\n    this.documentTypes = [{\n      value: NsbProfileDocumentType.NATIONAL_STANDARDS_ACT_DOCUMENT,\n      label: 'National Standards Act/Regulation'\n    }, {\n      value: NsbProfileDocumentType.NATIONAL_CONFORMITY_ASSESSMENT_POLICY_DOCUMENT,\n      label: 'National Conformity Assessment Policy'\n    }, {\n      value: NsbProfileDocumentType.NATIONAL_QUALITY_POLICY_DOCUMENT,\n      label: 'National Quality Policy'\n    }];\n    // Focal point types\n    this.focalPointTypes = [{\n      type: 'ACAP_COORDINATOR',\n      label: 'Designated ACAP Coordinator',\n      formArrayName: 'acapCoordinators'\n    }, {\n      type: 'MARKET_SURVEILLANCE_FOCAL_POINT',\n      label: 'Market Surveillance Focal Point',\n      formArrayName: 'marketSurveillanceContacts'\n    }, {\n      type: 'CUSTOMS_TRADE_FOCAL_POINT',\n      label: 'Customs/Trade Focal Point',\n      formArrayName: 'customsTradeContacts'\n    }, {\n      type: 'CONSUMER_AFFAIRS_FOCAL_POINT',\n      label: 'Consumer Affairs Focal Point',\n      formArrayName: 'consumerAffairsContacts'\n    }];\n    // Location types\n    this.locationTypes = [{\n      value: 'HEADQUARTERS',\n      label: 'Headquarters'\n    }, {\n      value: 'BRANCH',\n      label: 'Branch Office'\n    }, {\n      value: 'LABORATORY',\n      label: 'Laboratory'\n    }, {\n      value: 'REGIONAL_OFFICE',\n      label: 'Regional Office'\n    }];\n    this.form = this.fb.group({\n      // Auto-populated from Stage 1.1 (read-only)\n      countryId: [{\n        value: '',\n        disabled: true\n      }],\n      countryName: [{\n        value: '',\n        disabled: true\n      }],\n      name: [{\n        value: '',\n        disabled: true\n      }],\n      shortName: [{\n        value: '',\n        disabled: true\n      }],\n      // Official Address Details\n      headquartersAddress: [''],\n      mailingAddress: [''],\n      gpsCoordinates: [''],\n      regionalOffices: [''],\n      // Organizational Structure\n      totalStaff: [null, [Validators.min(0)]],\n      keyDepartments: [''],\n      websiteUrl: ['', [Validators.pattern(/^https?:\\/\\/.+/)]],\n      socialMediaTwitter: [''],\n      socialMediaLinkedIn: [''],\n      socialMediaFacebook: [''],\n      // National Legal Framework\n      nationalStandardsActLink: [''],\n      nationalConformityAssessmentPolicyLink: [''],\n      nationalQualityPolicyLink: [''],\n      // ACAP National Focal Points - using FormArray for multiple contacts\n      acapCoordinators: this.fb.array([]),\n      marketSurveillanceContacts: this.fb.array([]),\n      customsTradeContacts: this.fb.array([]),\n      consumerAffairsContacts: this.fb.array([])\n    });\n    // Location form\n    this.locationForm = this.fb.group({\n      id: [''],\n      locationType: ['HEADQUARTERS', Validators.required],\n      addressLine1: ['', Validators.required],\n      addressLine2: [''],\n      city: [''],\n      stateProvince: [''],\n      postalCode: [''],\n      countryId: [''],\n      latitude: [''],\n      longitude: [''],\n      isPrimary: [false]\n    });\n  }\n  // Helper methods for FormArrays\n  get acapCoordinators() {\n    return this.form.get('acapCoordinators');\n  }\n  get marketSurveillanceContacts() {\n    return this.form.get('marketSurveillanceContacts');\n  }\n  get customsTradeContacts() {\n    return this.form.get('customsTradeContacts');\n  }\n  get consumerAffairsContacts() {\n    return this.form.get('consumerAffairsContacts');\n  }\n  createContactFormGroup(contact) {\n    return this.fb.group({\n      id: [contact?.id || ''],\n      name: [contact?.name || '', Validators.required],\n      email: [contact?.email || '', [Validators.required, Validators.email]],\n      phone: [contact?.phone || ''],\n      mobile: [contact?.mobile || ''],\n      designation: [contact?.designation || '']\n    });\n  }\n  addContact(contactType) {\n    const formArrayMap = {\n      ACAP_COORDINATOR: this.acapCoordinators,\n      MARKET_SURVEILLANCE_FOCAL_POINT: this.marketSurveillanceContacts,\n      CUSTOMS_TRADE_FOCAL_POINT: this.customsTradeContacts,\n      CONSUMER_AFFAIRS_FOCAL_POINT: this.consumerAffairsContacts\n    };\n    const formArray = formArrayMap[contactType];\n    formArray.push(this.createContactFormGroup());\n  }\n  removeContact(contactType, index) {\n    const formArrayMap = {\n      ACAP_COORDINATOR: this.acapCoordinators,\n      MARKET_SURVEILLANCE_FOCAL_POINT: this.marketSurveillanceContacts,\n      CUSTOMS_TRADE_FOCAL_POINT: this.customsTradeContacts,\n      CONSUMER_AFFAIRS_FOCAL_POINT: this.consumerAffairsContacts\n    };\n    const formArray = formArrayMap[contactType];\n    const contactGroup = formArray.at(index);\n    const contactId = contactGroup.get('id')?.value;\n    // If contact has an ID, mark for deletion confirmation\n    if (contactId) {\n      this.deletingContact = {\n        type: contactType,\n        index\n      };\n    } else {\n      // New contact, just remove from form\n      formArray.removeAt(index);\n    }\n  }\n  confirmDeleteContact() {\n    if (!this.deletingContact) return;\n    const {\n      type,\n      index\n    } = this.deletingContact;\n    const formArrayMap = {\n      ACAP_COORDINATOR: this.acapCoordinators,\n      MARKET_SURVEILLANCE_FOCAL_POINT: this.marketSurveillanceContacts,\n      CUSTOMS_TRADE_FOCAL_POINT: this.customsTradeContacts,\n      CONSUMER_AFFAIRS_FOCAL_POINT: this.consumerAffairsContacts\n    };\n    const formArray = formArrayMap[type];\n    formArray.removeAt(index);\n    this.deletingContact = null;\n  }\n  cancelDeleteContact() {\n    this.deletingContact = null;\n  }\n  editContact(contactType, index) {\n    this.editingContact = {\n      type: contactType,\n      index\n    };\n  }\n  cancelEditContact() {\n    this.editingContact = null;\n  }\n  saveContact(contactType, index) {\n    const formArrayMap = {\n      ACAP_COORDINATOR: this.acapCoordinators,\n      MARKET_SURVEILLANCE_FOCAL_POINT: this.marketSurveillanceContacts,\n      CUSTOMS_TRADE_FOCAL_POINT: this.customsTradeContacts,\n      CONSUMER_AFFAIRS_FOCAL_POINT: this.consumerAffairsContacts\n    };\n    const formArray = formArrayMap[contactType];\n    const contactGroup = formArray.at(index);\n    if (contactGroup.invalid) {\n      contactGroup.markAllAsTouched();\n      return;\n    }\n    this.editingContact = null;\n  }\n  isEditingContact(contactType, index) {\n    return this.editingContact?.type === contactType && this.editingContact?.index === index;\n  }\n  isDeletingContact(contactType, index) {\n    return this.deletingContact?.type === contactType && this.deletingContact?.index === index;\n  }\n  onDocumentSelected(event, documentType) {\n    const input = event.target;\n    if (input.files && input.files[0]) {\n      const file = input.files[0];\n      this.selectedDocuments[documentType] = file;\n      // Upload immediately if NSB exists\n      if (this.nsb?.id) {\n        this.uploadDocument(documentType, file);\n      } else {\n        // Show error if NSB doesn't exist yet\n        this.error = 'Please save the profile first before uploading documents.';\n      }\n    }\n  }\n  uploadDocument(documentType, file) {\n    if (!this.nsb?.id) return;\n    this.nsbService.uploadDocument(this.nsb.id, file, documentType).subscribe({\n      next: document => {\n        this.loadDocuments();\n        delete this.selectedDocuments[documentType];\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to upload document. Please try again.';\n        delete this.selectedDocuments[documentType];\n      }\n    });\n  }\n  removeDocument(documentId, documentType, fileInput) {\n    if (!this.nsb?.id) return;\n    this.nsbService.deleteDocument(this.nsb.id, documentId).subscribe({\n      next: () => {\n        this.loadDocuments();\n        if (fileInput) {\n          fileInput.value = '';\n        }\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to delete document. Please try again.';\n      }\n    });\n  }\n  viewDocument(documentId) {\n    if (!this.nsb?.id) return;\n    window.open(this.nsbService.viewDocument(this.nsb.id, documentId), '_blank');\n  }\n  loadDocuments() {\n    if (!this.nsb?.id) return;\n    this.nsbService.getDocuments(this.nsb.id).subscribe({\n      next: documents => {\n        this.uploadedDocuments = documents;\n      },\n      error: () => {\n        // Error loading documents\n      }\n    });\n  }\n  getUploadedDocument(documentType) {\n    return this.uploadedDocuments.find(d => d.documentType === documentType);\n  }\n  getSelectedFileName(documentType) {\n    return this.selectedDocuments[documentType]?.name || '';\n  }\n  getFormArray(formArrayName) {\n    return this.form.get(formArrayName);\n  }\n  ngOnInit() {\n    this.loadData();\n    this.loadCountries();\n  }\n  loadData() {\n    this.loading = true;\n    const user = this.authService.currentUserValue;\n    // Load registration request first\n    if (user?.countryId) {\n      this.requestService.getMyRequest(user.countryId).subscribe({\n        next: request => {\n          this.registrationRequest = request;\n          if (request?.status === NsbRegistrationRequestStatus.APPROVED && request.nsbId) {\n            this.loadNsb(request.nsbId);\n          } else if (request?.status === NsbRegistrationRequestStatus.APPROVED) {\n            // Request approved but NSB not found - this shouldn't happen\n            this.error = 'NSB profile not found. Please contact ARSO Secretariat.';\n            this.loading = false;\n          } else {\n            this.error = 'Your registration request has not been approved yet.';\n            this.loading = false;\n          }\n        },\n        error: () => {\n          this.error = 'No approved registration request found.';\n          this.loading = false;\n        }\n      });\n    } else {\n      // Try to load NSB directly\n      this.nsbService.getMyNsb().subscribe({\n        next: nsb => {\n          this.nsb = nsb;\n          this.loadNsbData(nsb);\n          this.loading = false;\n        },\n        error: () => {\n          this.error = 'NSB profile not found.';\n          this.loading = false;\n        }\n      });\n    }\n  }\n  loadNsb(nsbId) {\n    this.nsbService.getNsbById(nsbId).pipe(finalize(() => {\n      this.loading = false;\n    })).subscribe({\n      next: nsb => {\n        this.nsb = nsb;\n        this.loadNsbData(nsb);\n      },\n      error: () => {\n        this.error = 'Failed to load NSB profile.';\n      }\n    });\n  }\n  loadNsbData(nsb) {\n    // Load data from registration request if available\n    if (this.registrationRequest) {\n      this.form.patchValue({\n        countryId: this.registrationRequest.countryId,\n        countryName: this.registrationRequest.countryName,\n        name: this.registrationRequest.nsbOfficialName,\n        shortName: this.registrationRequest.nsbAcronym\n      });\n    } else if (nsb) {\n      this.form.patchValue({\n        countryId: nsb.countryId,\n        countryName: nsb.country?.name || '',\n        name: nsb.name,\n        shortName: nsb.shortName\n      });\n    }\n    // Load NSB profile fields\n    if (nsb) {\n      const headquarters = nsb.locations?.find(l => l.locationType === 'HEADQUARTERS');\n      const socialMedia = nsb.socialMediaHandles || {};\n      this.form.patchValue({\n        totalStaff: nsb.totalStaff,\n        keyDepartments: nsb.keyDepartments?.join(', ') || '',\n        websiteUrl: nsb.websiteUrl,\n        socialMediaTwitter: socialMedia.twitter || '',\n        socialMediaLinkedIn: socialMedia.linkedin || '',\n        socialMediaFacebook: socialMedia.facebook || '',\n        nationalStandardsActLink: nsb.nationalStandardsActLink || '',\n        nationalConformityAssessmentPolicyLink: nsb.nationalConformityAssessmentPolicyLink || '',\n        nationalQualityPolicyLink: nsb.nationalQualityPolicyLink\n      });\n      if (headquarters) {\n        this.form.patchValue({\n          headquartersAddress: headquarters.addressLine1 || '',\n          mailingAddress: headquarters.addressLine2 || '',\n          gpsCoordinates: headquarters.latitude && headquarters.longitude ? `${headquarters.latitude}, ${headquarters.longitude}` : ''\n        });\n      }\n      // Load locations\n      this.locations = nsb.locations || [];\n      // Load focal point contacts\n      this.loadFocalPointContacts(nsb);\n      // Load documents\n      this.loadDocuments();\n    }\n  }\n  // Location CRUD operations\n  addLocation() {\n    this.locationForm.reset({\n      locationType: 'HEADQUARTERS',\n      isPrimary: false\n    });\n    this.editingLocationIndex = null;\n    this.showLocationForm = true;\n  }\n  editLocation(index) {\n    const location = this.locations[index];\n    this.locationForm.patchValue({\n      id: location.id || '',\n      locationType: location.locationType,\n      addressLine1: location.addressLine1 || '',\n      addressLine2: location.addressLine2 || '',\n      city: location.city || '',\n      stateProvince: location.stateProvince || '',\n      postalCode: location.postalCode || '',\n      countryId: location.countryId || '',\n      latitude: location.latitude?.toString() || '',\n      longitude: location.longitude?.toString() || '',\n      isPrimary: location.isPrimary || false\n    });\n    this.editingLocationIndex = index;\n    this.showLocationForm = true;\n  }\n  saveLocation() {\n    if (this.locationForm.invalid) {\n      this.locationForm.markAllAsTouched();\n      return;\n    }\n    const formValue = this.locationForm.value;\n    const location = {\n      id: formValue.id || undefined,\n      locationType: formValue.locationType,\n      addressLine1: formValue.addressLine1,\n      addressLine2: formValue.addressLine2 || undefined,\n      city: formValue.city || undefined,\n      stateProvince: formValue.stateProvince || undefined,\n      postalCode: formValue.postalCode || undefined,\n      countryId: formValue.countryId || undefined,\n      latitude: formValue.latitude ? parseFloat(formValue.latitude) : undefined,\n      longitude: formValue.longitude ? parseFloat(formValue.longitude) : undefined,\n      isPrimary: formValue.isPrimary || false\n    };\n    if (this.editingLocationIndex !== null) {\n      // Update existing location\n      this.locations[this.editingLocationIndex] = location;\n    } else {\n      // Add new location\n      this.locations.push(location);\n    }\n    this.cancelLocationForm();\n  }\n  deleteLocation(index) {\n    if (confirm('Are you sure you want to delete this location?')) {\n      this.locations.splice(index, 1);\n    }\n  }\n  cancelLocationForm() {\n    this.locationForm.reset();\n    this.editingLocationIndex = null;\n    this.showLocationForm = false;\n  }\n  getLocationTypeLabel(locationType) {\n    const type = this.locationTypes.find(t => t.value === locationType);\n    return type?.label || locationType;\n  }\n  getHeadquartersLocation() {\n    return this.locations.find(l => l.locationType === 'HEADQUARTERS');\n  }\n  loadFocalPointContacts(nsb) {\n    if (!nsb.contacts) return;\n    // Clear existing form arrays\n    while (this.acapCoordinators.length) this.acapCoordinators.removeAt(0);\n    while (this.marketSurveillanceContacts.length) this.marketSurveillanceContacts.removeAt(0);\n    while (this.customsTradeContacts.length) this.customsTradeContacts.removeAt(0);\n    while (this.consumerAffairsContacts.length) this.consumerAffairsContacts.removeAt(0);\n    // Load contacts by type\n    const acapContacts = nsb.contacts.filter(c => c.contactType === 'ACAP_COORDINATOR');\n    const marketContacts = nsb.contacts.filter(c => c.contactType === 'MARKET_SURVEILLANCE_FOCAL_POINT');\n    const customsContacts = nsb.contacts.filter(c => c.contactType === 'CUSTOMS_TRADE_FOCAL_POINT');\n    const consumerContacts = nsb.contacts.filter(c => c.contactType === 'CONSUMER_AFFAIRS_FOCAL_POINT');\n    // Populate form arrays\n    acapContacts.forEach(contact => {\n      this.acapCoordinators.push(this.createContactFormGroup(contact));\n    });\n    marketContacts.forEach(contact => {\n      this.marketSurveillanceContacts.push(this.createContactFormGroup(contact));\n    });\n    customsContacts.forEach(contact => {\n      this.customsTradeContacts.push(this.createContactFormGroup(contact));\n    });\n    consumerContacts.forEach(contact => {\n      this.consumerAffairsContacts.push(this.createContactFormGroup(contact));\n    });\n    // If no contacts exist, add one empty contact for each type\n    if (this.acapCoordinators.length === 0) {\n      this.acapCoordinators.push(this.createContactFormGroup());\n    }\n    if (this.marketSurveillanceContacts.length === 0) {\n      this.marketSurveillanceContacts.push(this.createContactFormGroup());\n    }\n    if (this.customsTradeContacts.length === 0) {\n      this.customsTradeContacts.push(this.createContactFormGroup());\n    }\n    if (this.consumerAffairsContacts.length === 0) {\n      this.consumerAffairsContacts.push(this.createContactFormGroup());\n    }\n  }\n  loadCountries() {\n    this.countryService.getCountries().subscribe({\n      next: data => {\n        this.countries = data;\n      },\n      error: () => {\n        // Error loading countries\n      }\n    });\n  }\n  // Action for \"Save Draft\"\n  saveDraft() {\n    this.executeSave(true);\n  }\n  // Action for \"Save & Submit\" (Final Save)\n  onSubmit() {\n    if (this.form.invalid) {\n      this.form.markAllAsTouched();\n      this.error = 'Please fill in all required fields before completing the profile.';\n      return;\n    }\n    this.executeSave(false);\n  }\n  executeSave(isDraft) {\n    this.saving = true;\n    this.error = '';\n    this.success = false;\n    const formValue = this.form.getRawValue();\n    const keyDepartments = formValue.keyDepartments ? formValue.keyDepartments.split(',').map(d => d.trim()).filter(d => d) : [];\n    const socialMediaHandles = {};\n    if (formValue.socialMediaTwitter) socialMediaHandles.twitter = formValue.socialMediaTwitter;\n    if (formValue.socialMediaLinkedIn) socialMediaHandles.linkedin = formValue.socialMediaLinkedIn;\n    if (formValue.socialMediaFacebook) socialMediaHandles.facebook = formValue.socialMediaFacebook;\n    // Build contacts array from form arrays\n    const contacts = [];\n    // Helper to collect contacts\n    const collectContacts = (source, type) => {\n      source.forEach(contact => {\n        // For draft, we might save even incomplete contacts if they have at least a name\n        // For final, validation ensures required fields\n        if (contact.name) {\n          contacts.push({\n            id: contact.id || undefined,\n            contactType: type,\n            name: contact.name,\n            email: contact.email,\n            phone: contact.phone || undefined,\n            mobile: contact.mobile || undefined,\n            designation: contact.designation || undefined\n          });\n        }\n      });\n    };\n    collectContacts(formValue.acapCoordinators, 'ACAP_COORDINATOR');\n    collectContacts(formValue.marketSurveillanceContacts, 'MARKET_SURVEILLANCE_FOCAL_POINT');\n    collectContacts(formValue.customsTradeContacts, 'CUSTOMS_TRADE_FOCAL_POINT');\n    collectContacts(formValue.consumerAffairsContacts, 'CONSUMER_AFFAIRS_FOCAL_POINT');\n    // Process GPS coordinates if provided\n    let headquartersLocation = this.getHeadquartersLocation();\n    if (formValue.gpsCoordinates) {\n      const [lat, lng] = formValue.gpsCoordinates.split(',').map(s => s.trim());\n      if (lat && lng && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {\n        if (!headquartersLocation) {\n          headquartersLocation = {\n            locationType: 'HEADQUARTERS',\n            addressLine1: formValue.headquartersAddress || '',\n            addressLine2: formValue.mailingAddress || undefined,\n            latitude: parseFloat(lat),\n            longitude: parseFloat(lng)\n          };\n          this.locations.push(headquartersLocation);\n        } else {\n          headquartersLocation.latitude = parseFloat(lat);\n          headquartersLocation.longitude = parseFloat(lng);\n        }\n      }\n    }\n    // Update headquarters address if provided\n    if (formValue.headquartersAddress || formValue.mailingAddress) {\n      if (!headquartersLocation) {\n        headquartersLocation = {\n          locationType: 'HEADQUARTERS',\n          addressLine1: formValue.headquartersAddress || '',\n          addressLine2: formValue.mailingAddress || undefined\n        };\n        this.locations.push(headquartersLocation);\n      } else {\n        headquartersLocation.addressLine1 = formValue.headquartersAddress || headquartersLocation.addressLine1;\n        headquartersLocation.addressLine2 = formValue.mailingAddress || headquartersLocation.addressLine2;\n      }\n    }\n    const dto = {\n      websiteUrl: formValue.websiteUrl,\n      socialMediaHandles: Object.keys(socialMediaHandles).length > 0 ? socialMediaHandles : undefined,\n      totalStaff: formValue.totalStaff ? parseInt(formValue.totalStaff, 10) : undefined,\n      keyDepartments: keyDepartments.length > 0 ? keyDepartments : undefined,\n      nationalStandardsActLink: formValue.nationalStandardsActLink,\n      nationalConformityAssessmentPolicyLink: formValue.nationalConformityAssessmentPolicyLink,\n      nationalQualityPolicyLink: formValue.nationalQualityPolicyLink,\n      contacts: contacts.length > 0 ? contacts : undefined,\n      locations: this.locations.length > 0 ? this.locations : undefined\n    };\n    if (!this.nsb?.id) {\n      this.error = 'NSB profile not found. Please contact ARSO Secretariat.';\n      this.saving = false;\n      return;\n    }\n    this.nsbService.updateNsb(this.nsb.id, dto).pipe(finalize(() => {\n      this.saving = false;\n    })).subscribe({\n      next: nsb => {\n        this.nsb = nsb;\n        this.success = true;\n        this.successMessage = isDraft ? 'Draft saved successfully.' : 'Profile saved and updated successfully.';\n        this.loadDocuments();\n        // Upload any pending documents after profile is saved\n        Object.keys(this.selectedDocuments).forEach(docType => {\n          const file = this.selectedDocuments[docType];\n          if (file && this.nsb?.id) {\n            this.uploadDocument(docType, file);\n          }\n        });\n      },\n      error: err => {\n        this.error = err.error?.message || 'Failed to save profile. Please try again.';\n      }\n    });\n  }\n  goToDashboard() {\n    this.router.navigate(['/nsb/dashboard']);\n  }\n};\nNsbProfileSetupComponent = __decorate([Component({\n  selector: 'app-nsb-profile-setup',\n  templateUrl: './nsb-profile-setup.component.html',\n  styleUrls: ['./nsb-profile-setup.component.scss']\n})], NsbProfileSetupComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}